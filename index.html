<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>FibroFlow â€” Symptom Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,300;0,400;1,300;1,400&family=Outfit:wght@300;400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:       #0c0e14;
  --s0:       #111318;
  --s1:       #181b24;
  --s2:       #1f2230;
  --s3:       #272b3c;
  --border:   rgba(255,255,255,0.07);
  --bmd:      rgba(255,255,255,0.13);
  --text:     #eceaf6;
  --muted:    #6e6d88;
  --dim:      #3c3b52;
  --teal:     #5ccfbe;
  --teal-d:   rgba(92,207,190,0.15);
  --rose:     #e8778a;
  --rose-d:   rgba(232,119,138,0.15);
  --amber:    #f2a94e;
  --lavender: #9f8fe8;
  --sky:      #6ab0f5;
  --sage:     #7ec99a;
  --sage-d:   rgba(126,201,154,0.15);
  --radius:   18px;
  --rsm:      10px;
  --rxs:      8px;
  --nav-h:    58px;        /* desktop top nav height */
  --bot-h:    64px;        /* mobile bottom nav height */
  --safe-bot: env(safe-area-inset-bottom, 0px);
}

*,*::before,*::after { box-sizing:border-box; margin:0; padding:0; }
html { scroll-behavior:smooth; }

body {
  font-family:'Outfit',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
  font-size:15px;
  /* room for mobile bottom nav */
  padding-bottom:0;
}

body::before {
  content:'';
  position:fixed; inset:0; z-index:0; pointer-events:none;
  background:
    radial-gradient(ellipse 70% 55% at 10% 0%,rgba(92,207,190,0.06) 0%,transparent 70%),
    radial-gradient(ellipse 50% 60% at 90% 100%,rgba(159,143,232,0.05) 0%,transparent 70%),
    radial-gradient(ellipse 40% 40% at 50% 50%,rgba(232,119,138,0.03) 0%,transparent 70%);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESKTOP TOP NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.top-nav {
  position:sticky; top:0; z-index:200;
  background:rgba(12,14,20,0.9);
  backdrop-filter:blur(24px);
  border-bottom:1px solid var(--border);
  display:flex; align-items:center;
  padding:0 20px; height:var(--nav-h); gap:4px;
}
.nav-brand {
  font-family:'Fraunces',serif;
  font-size:1.2rem; font-weight:400;
  color:var(--teal); letter-spacing:-0.03em;
  margin-right:auto;
  display:flex; align-items:baseline; gap:6px;
}
.nav-brand em {
  font-size:0.7rem; font-style:italic;
  color:var(--muted); font-family:'Outfit',sans-serif; font-weight:300;
}
.nav-pill {
  display:flex; background:var(--s1);
  border:1px solid var(--border); border-radius:30px; padding:3px; gap:2px;
}
.nav-tab {
  padding:5px 16px; border-radius:24px; border:none;
  background:transparent; color:var(--muted);
  font-family:'Outfit',sans-serif; font-size:0.8rem; font-weight:500;
  cursor:pointer; transition:all 0.2s; white-space:nowrap;
}
.nav-tab:hover { color:var(--text); }
.nav-tab.active { background:var(--s3); color:var(--teal); border:1px solid rgba(92,207,190,0.25); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bot-nav {
  display:none;
  position:fixed; bottom:0; left:0; right:0; z-index:200;
  background:rgba(12,14,20,0.95);
  backdrop-filter:blur(24px);
  border-top:1px solid var(--border);
  padding-bottom:var(--safe-bot);
  height:calc(var(--bot-h) + var(--safe-bot));
}
.bot-nav-inner {
  display:flex; height:var(--bot-h);
}
.bot-tab {
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:3px;
  border:none; background:transparent;
  color:var(--muted); font-family:'Outfit',sans-serif;
  font-size:0.65rem; font-weight:500; cursor:pointer;
  transition:all 0.2s; padding:8px 4px;
  -webkit-tap-highlight-color:transparent;
}
.bot-tab .bt-icon { font-size:1.3rem; line-height:1; transition:transform 0.2s; }
.bot-tab.active { color:var(--teal); }
.bot-tab.active .bt-icon { transform:scale(1.15); }
.bot-tab:active .bt-icon { transform:scale(0.92); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGES & CONTAINER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page { display:none; position:relative; z-index:1; }
.page.active { display:block; animation:fadeUp 0.28s ease both; }
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:none} }

.container {
  max-width:820px; margin:0 auto;
  padding:24px 16px 100px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-header { margin-bottom:24px; }
.page-header h1 {
  font-family:'Fraunces',serif; font-size:2rem; font-weight:300;
  letter-spacing:-0.04em; line-height:1.1;
}
.page-header h1 em { color:var(--teal); font-style:italic; }
.page-header .sub { margin-top:5px; font-size:0.82rem; color:var(--muted); font-weight:300; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TIMESTAMP BANNER (replaces session tabs)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timestamp-banner {
  display:flex; align-items:center; gap:10px;
  background:var(--s1); border:1px solid var(--border);
  border-radius:var(--rsm); padding:12px 16px; margin-bottom:16px;
}
.ts-icon { font-size:1.1rem; flex-shrink:0; }
.ts-content { flex:1; min-width:0; }
.ts-label { font-size:0.68rem; color:var(--dim); text-transform:uppercase; letter-spacing:0.08em; }
.ts-value { font-family:'JetBrains Mono',monospace; font-size:0.88rem; color:var(--teal); margin-top:2px; }
.ts-location { font-size:0.72rem; color:var(--muted); margin-top:2px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background:var(--s0); border:1px solid var(--border);
  border-radius:var(--radius); padding:20px;
  margin-bottom:12px; position:relative; overflow:hidden;
}
.card::before {
  content:''; position:absolute; top:0; left:0; right:0; height:1px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,0.06),transparent);
}
.card-header {
  display:flex; align-items:center; justify-content:space-between;
  margin-bottom:16px; gap:8px;
}
.card-title {
  display:flex; align-items:center; gap:8px;
  font-size:0.68rem; font-weight:600;
  letter-spacing:0.12em; text-transform:uppercase; color:var(--muted);
}
.accent-bar { width:3px; height:14px; border-radius:2px; flex-shrink:0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WEATHER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wx-status {
  display:flex; align-items:center; gap:10px;
  padding:10px 14px; border-radius:var(--rsm);
  background:var(--s1); border:1px solid var(--border);
  margin-bottom:12px; font-size:0.8rem; color:var(--muted);
}
.wx-status.success { border-color:rgba(126,201,154,0.3); color:var(--sage); background:var(--sage-d); }
.wx-status.error   { border-color:rgba(232,119,138,0.3); color:var(--rose); background:var(--rose-d); }

.wx-grid {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(100px,1fr)); gap:7px;
}
.wx-tile {
  background:var(--s1); border:1px solid var(--border);
  border-radius:var(--rsm); padding:10px 8px; text-align:center;
}
.wx-icon { font-size:1.1rem; margin-bottom:3px; }
.wx-lbl { font-size:0.6rem; color:var(--dim); text-transform:uppercase; letter-spacing:0.07em; margin-bottom:4px; }
.wx-val {
  font-family:'JetBrains Mono',monospace; font-size:0.82rem;
  color:var(--text); min-height:20px; display:flex; align-items:center; justify-content:center;
}
.wx-val.empty { color:var(--dim); }
.wx-input {
  width:100%; background:var(--s2); border:1px solid var(--bmd);
  border-radius:5px; color:var(--text); font-family:'JetBrains Mono',monospace;
  font-size:0.76rem; padding:4px 6px; text-align:center; outline:none;
}
.wx-input:focus { border-color:var(--teal); }
.wx-input::placeholder { color:var(--dim); }

/* Manual toggle */
.manual-panel { display:none; margin-top:10px; }
.manual-panel.open { display:block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCALE â€” SLIDER VERSION (mobile-optimised)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.scale-group { margin-bottom:20px; }
.scale-head {
  display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;
}
.scale-name { font-size:0.88rem; font-weight:500; color:var(--text); flex:1; }
.scale-badge {
  font-family:'JetBrains Mono',monospace; font-size:0.82rem;
  padding:3px 10px; border-radius:20px; background:var(--s2);
  border:1px solid var(--border); color:var(--muted); min-width:40px;
  text-align:center; transition:all 0.2s; font-weight:600;
}

/* Slider wrapper */
.slider-wrap { position:relative; padding:4px 0; }
.scale-slider {
  -webkit-appearance:none; appearance:none;
  width:100%; height:8px; border-radius:4px;
  background:var(--s2); outline:none; cursor:pointer;
  transition:background 0.15s;
}
.scale-slider::-webkit-slider-thumb {
  -webkit-appearance:none; appearance:none;
  width:28px; height:28px; border-radius:50%;
  background:var(--teal); border:3px solid var(--bg);
  box-shadow:0 0 10px rgba(92,207,190,0.5);
  cursor:pointer; transition:all 0.15s;
}
.scale-slider::-moz-range-thumb {
  width:28px; height:28px; border-radius:50%;
  background:var(--teal); border:3px solid var(--bg);
  box-shadow:0 0 10px rgba(92,207,190,0.5);
  cursor:pointer;
}
.scale-slider:active::-webkit-slider-thumb { transform:scale(1.18); }
.scale-hints { display:flex; justify-content:space-between; margin-top:5px; font-size:0.63rem; color:var(--dim); font-style:italic; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHECKBOXES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.check-grid {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(148px,1fr)); gap:6px; margin-bottom:6px;
}
.check-tile {
  display:flex; align-items:center; gap:8px;
  padding:11px 10px; background:var(--s1); border:1px solid var(--border);
  border-radius:var(--rxs); cursor:pointer; transition:all 0.15s;
  font-size:0.82rem; color:var(--muted); user-select:none;
  min-height:44px; /* touch target */
}
.check-tile:hover { background:var(--s2); color:var(--text); }
.check-tile.on { background:rgba(92,207,190,0.08); border-color:rgba(92,207,190,0.3); color:var(--text); }
.check-box {
  width:18px; height:18px; border-radius:5px; border:1.5px solid var(--dim);
  flex-shrink:0; display:flex; align-items:center; justify-content:center;
  font-size:10px; font-weight:700; color:transparent; transition:all 0.15s;
}
.check-tile.on .check-box { background:var(--teal); border-color:var(--teal); color:var(--bg); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOOD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mood-row {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(72px,1fr)); gap:7px; margin-bottom:16px;
}
.mood-tile {
  padding:12px 6px 10px; background:var(--s1); border:1px solid var(--border);
  border-radius:var(--rsm); cursor:pointer; text-align:center;
  transition:all 0.15s; user-select:none; min-height:44px;
}
.mood-tile:hover { background:var(--s2); }
.mood-tile.on { background:rgba(92,207,190,0.08); border-color:rgba(92,207,190,0.4); }
.mood-tile .me { font-size:1.5rem; display:block; margin-bottom:4px; line-height:1; }
.mood-tile .ml { font-size:0.68rem; color:var(--muted); }
.mood-tile.on .ml { color:var(--teal); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DIVIDER / SECTION LABEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.divider { border:none; border-top:1px solid var(--border); margin:18px 0; }
.section-label {
  font-size:0.84rem; font-weight:500; color:var(--text);
  margin-bottom:10px; display:flex; align-items:center; justify-content:space-between;
}
.section-label .hint { font-size:0.72rem; color:var(--muted); font-weight:300; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TEXTAREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.fibro-textarea {
  width:100%; background:var(--s1); border:1px solid var(--border);
  border-radius:var(--rsm); color:var(--text); font-family:'Outfit',sans-serif;
  font-size:0.88rem; font-weight:300; padding:13px; resize:vertical;
  min-height:90px; outline:none; transition:border-color 0.2s; line-height:1.6;
}
.fibro-textarea:focus { border-color:rgba(92,207,190,0.4); }
.fibro-textarea::placeholder { color:var(--dim); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BUTTONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.btn {
  display:inline-flex; align-items:center; gap:7px;
  padding:12px 22px; border-radius:var(--rsm); border:none;
  cursor:pointer; font-family:'Outfit',sans-serif;
  font-size:0.88rem; font-weight:600; transition:all 0.2s;
  white-space:nowrap; min-height:44px; -webkit-tap-highlight-color:transparent;
}
.btn-primary {
  background:linear-gradient(135deg,var(--teal),#3ab5ac);
  color:var(--bg); box-shadow:0 4px 18px rgba(92,207,190,0.25);
}
.btn-primary:hover { transform:translateY(-1px); box-shadow:0 6px 24px rgba(92,207,190,0.35); }
.btn-primary:active { transform:none; }
.btn-ghost {
  background:var(--s1); border:1px solid var(--border); color:var(--muted);
}
.btn-ghost:hover { background:var(--s2); color:var(--text); }
.btn-danger { background:var(--s1); border:1px solid rgba(232,119,138,0.3); color:var(--rose); }
.btn-danger:hover { background:var(--rose-d); }
.btn-sm { padding:8px 14px; font-size:0.8rem; min-height:38px; }
.btn-xs { padding:5px 10px; font-size:0.73rem; min-height:32px; }
.btn-row { display:flex; flex-wrap:wrap; gap:8px; margin-top:18px; align-items:center; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOBILE WIZARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wizard-progress {
  display:none; /* shown via JS on mobile */
  margin-bottom:16px;
}
.wizard-bar-wrap { background:var(--s2); border-radius:6px; height:4px; margin-bottom:8px; overflow:hidden; }
.wizard-bar { height:100%; background:linear-gradient(90deg,var(--teal),var(--lavender)); border-radius:6px; transition:width 0.35s ease; }
.wizard-meta { display:flex; justify-content:space-between; font-size:0.7rem; color:var(--dim); }

.wizard-step { display:none; }
.wizard-step.active { display:block; animation:fadeUp 0.22s ease both; }

.wizard-nav {
  display:none; /* shown on mobile */
  position:fixed; bottom:calc(var(--bot-h) + var(--safe-bot)); left:0; right:0;
  padding:10px 16px; background:rgba(12,14,20,0.95);
  backdrop-filter:blur(16px); border-top:1px solid var(--border);
  z-index:150; gap:8px;
}
.wizard-nav.visible { display:flex; }

/* Sticky save (desktop floating) */
.sticky-save-desktop {
  position:fixed; bottom:24px; right:24px; z-index:150;
  display:none; /* shown on desktop when on log page */
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOCATION MANUAL FIELD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.location-manual {
  display:none; margin-top:8px;
  background:var(--s1); border:1px solid var(--border);
  border-radius:var(--rsm); padding:12px;
}
.location-manual.show { display:block; }
.loc-input {
  width:100%; background:var(--s2); border:1px solid var(--bmd);
  border-radius:6px; color:var(--text); font-family:'Outfit',sans-serif;
  font-size:0.85rem; padding:10px 12px; outline:none; transition:border-color 0.2s;
}
.loc-input:focus { border-color:var(--teal); }
.loc-input::placeholder { color:var(--dim); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast {
  position:fixed; bottom:calc(var(--bot-h) + var(--safe-bot) + 12px); left:50%;
  transform:translateX(-50%) translateY(120px);
  background:var(--s2); border:1px solid var(--bmd); color:var(--text);
  padding:11px 22px; border-radius:30px; font-size:0.83rem; font-weight:500;
  z-index:500; transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
  box-shadow:0 8px 40px rgba(0,0,0,0.5); pointer-events:none; white-space:nowrap;
}
.toast.show { transform:translateX(-50%) translateY(0); }
.toast.success { border-color:rgba(126,201,154,0.4); color:var(--sage); }
.toast.error   { border-color:rgba(232,119,138,0.4); color:var(--rose); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DASHBOARD â€” CONTROLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dash-stats {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(110px,1fr)); gap:8px; margin-bottom:18px;
}
.stat-box { background:var(--s0); border:1px solid var(--border); border-radius:var(--rsm); padding:14px; text-align:center; }
.stat-val { font-family:'Fraunces',serif; font-size:1.8rem; font-weight:300; color:var(--teal); line-height:1; margin-bottom:4px; }
.stat-lbl { font-size:0.65rem; color:var(--dim); text-transform:uppercase; letter-spacing:0.07em; }

.dash-controls {
  display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; align-items:flex-end;
}
.ctrl-group { display:flex; flex-direction:column; gap:4px; }
.ctrl-label { font-size:0.68rem; color:var(--dim); font-weight:600; letter-spacing:0.07em; text-transform:uppercase; }
.ctrl-select {
  background:var(--s1); border:1px solid var(--border); color:var(--text);
  padding:8px 10px; border-radius:var(--rxs); font-size:0.82rem;
  font-family:'Outfit',sans-serif; cursor:pointer; outline:none; min-height:38px;
}
.ctrl-select:focus { border-color:var(--teal); }

/* Custom date range */
.date-range-row {
  display:none; /* shown when "custom" selected */
  gap:8px; align-items:flex-end; flex-wrap:wrap; margin-bottom:8px;
}
.date-range-row.show { display:flex; }
.date-input {
  background:var(--s1); border:1px solid var(--border); color:var(--text);
  padding:8px 10px; border-radius:var(--rxs); font-size:0.82rem;
  font-family:'Outfit',sans-serif; outline:none; min-height:38px;
  color-scheme:dark;
}
.date-input:focus { border-color:var(--teal); }

/* Filter chips */
.chip-section-label { font-size:0.67rem; color:var(--dim); text-transform:uppercase; letter-spacing:0.08em; font-weight:600; margin-bottom:5px; margin-top:12px; }
.chip-row { display:flex; flex-wrap:wrap; gap:5px; margin-bottom:4px; }
.chip {
  display:flex; align-items:center; gap:5px;
  padding:6px 11px; border-radius:20px; border:1px solid var(--border);
  background:var(--s1); color:var(--muted); font-size:0.73rem; font-weight:500;
  cursor:pointer; transition:all 0.15s; user-select:none; min-height:32px;
}
.chip:hover { background:var(--s2); color:var(--text); }
.chip.on { border-color:rgba(92,207,190,0.4); background:rgba(92,207,190,0.07); color:var(--teal); }
.chip .cdot { width:6px; height:6px; border-radius:50%; flex-shrink:0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHARTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chart-wrap {
  background:var(--s0); border:1px solid var(--border);
  border-radius:var(--radius); padding:18px 16px 14px; margin-bottom:12px; position:relative;
}
.chart-header { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap; gap:8px; }
.chart-label { font-size:0.67rem; font-weight:600; letter-spacing:0.1em; text-transform:uppercase; color:var(--muted); display:flex; align-items:center; gap:7px; }
.chart-meta { font-size:0.67rem; color:var(--dim); font-style:italic; }
.chart-legend { display:flex; flex-wrap:wrap; gap:5px 12px; margin-bottom:12px; }
.legend-item {
  display:flex; align-items:center; gap:5px; font-size:0.72rem; color:var(--muted);
  cursor:pointer; transition:color 0.15s;
}
.legend-item:hover { color:var(--text); }
.legend-item.hidden { opacity:0.3; text-decoration:line-through; }
.legend-swatch { width:20px; height:3px; border-radius:2px; flex-shrink:0; position:relative; }
.legend-swatch::after {
  content:''; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  width:7px; height:7px; border-radius:50%; background:inherit; border:1.5px solid var(--bg);
}

/* Per-chart fill toggle */
.fill-toggle-btn {
  background:none; border:1px solid var(--border); color:var(--dim);
  border-radius:20px; padding:4px 10px; font-size:0.68rem;
  cursor:pointer; font-family:'Outfit',sans-serif; transition:all 0.15s;
  white-space:nowrap;
}
.fill-toggle-btn:hover { color:var(--text); border-color:var(--bmd); }
.fill-toggle-btn.on { color:var(--teal); border-color:rgba(92,207,190,0.4); background:rgba(92,207,190,0.06); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AQI BADGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.aqi-badge {
  display:inline-flex; align-items:center; gap:5px;
  padding:3px 9px; border-radius:20px; font-size:0.72rem; font-weight:600;
  border:1px solid currentColor; opacity:0.9;
}
.aqi-good        { color:#7ec99a; background:rgba(126,201,154,0.12); }
.aqi-moderate    { color:#f2e94e; background:rgba(242,233,78,0.10); }
.aqi-sensitive   { color:#f2a94e; background:rgba(242,169,78,0.12); }
.aqi-unhealthy   { color:#e8778a; background:rgba(232,119,138,0.12); }
.aqi-very        { color:#c084fc; background:rgba(192,132,252,0.12); }
.aqi-hazardous   { color:#f05050; background:rgba(240,80,80,0.15); }

/* Air quality section divider inside env card */
.aq-divider {
  font-size:0.67rem; color:var(--dim); text-transform:uppercase;
  letter-spacing:0.08em; font-weight:600; margin:12px 0 8px;
  display:flex; align-items:center; gap:8px;
}
.aq-divider::after { content:''; flex:1; height:1px; background:var(--border); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHORTCUT BUTTONS (None today / Same as yesterday)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.shortcut-row {
  display:flex; gap:7px; flex-wrap:wrap; margin-bottom:14px;
}
.shortcut-btn {
  display:inline-flex; align-items:center; gap:5px;
  padding:7px 13px; border-radius:20px;
  border:1px solid var(--border); background:var(--s1);
  color:var(--muted); font-size:0.78rem; font-weight:500;
  cursor:pointer; transition:all 0.15s; min-height:36px;
  font-family:'Outfit',sans-serif;
  -webkit-tap-highlight-color:transparent;
}
.shortcut-btn:hover { background:var(--s2); color:var(--text); border-color:var(--bmd); }
.shortcut-btn.yesterday { border-color:rgba(92,207,190,0.3); color:var(--teal); background:rgba(92,207,190,0.06); }

/* "None today" per-section */
.none-today-btn {
  font-size:0.72rem; color:var(--dim); background:none; border:none;
  cursor:pointer; font-family:'Outfit',sans-serif; padding:0 0 8px 2px;
  transition:color 0.15s; display:inline-flex; align-items:center; gap:4px;
}
.none-today-btn:hover { color:var(--muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM SHEET (mobile chart filters)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sheet-backdrop {
  display:none; position:fixed; inset:0; z-index:300;
  background:rgba(0,0,0,0.6); backdrop-filter:blur(4px);
}
.sheet-backdrop.open { display:block; }

.bottom-sheet {
  position:fixed; bottom:0; left:0; right:0; z-index:301;
  background:var(--s1); border-top:1px solid var(--bmd);
  border-radius:20px 20px 0 0;
  padding-bottom:var(--safe-bot);
  transform:translateY(100%);
  transition:transform 0.35s cubic-bezier(0.32,0.72,0,1);
  max-height:80vh; display:flex; flex-direction:column;
}
.bottom-sheet.open { transform:translateY(0); }

.sheet-handle {
  width:36px; height:4px; border-radius:2px; background:var(--dim);
  margin:10px auto 0; flex-shrink:0;
}
.sheet-header {
  display:flex; align-items:center; justify-content:space-between;
  padding:12px 18px 10px; flex-shrink:0; border-bottom:1px solid var(--border);
}
.sheet-title { font-size:0.9rem; font-weight:600; color:var(--text); }
.sheet-done {
  background:var(--teal); color:var(--bg); border:none;
  padding:6px 16px; border-radius:20px; font-size:0.8rem;
  font-weight:600; cursor:pointer; font-family:'Outfit',sans-serif;
  min-height:34px;
}
.sheet-body { overflow-y:auto; padding:12px 14px 20px; flex:1; }

/* 2-column toggle grid inside sheet */
.sheet-toggle-grid {
  display:grid; grid-template-columns:1fr 1fr; gap:8px;
}
.sheet-toggle {
  display:flex; align-items:center; gap:9px;
  padding:13px 12px; border-radius:var(--rsm);
  border:1px solid var(--border); background:var(--s2);
  cursor:pointer; transition:all 0.15s; min-height:52px;
  -webkit-tap-highlight-color:transparent;
}
.sheet-toggle:active { transform:scale(0.97); }
.sheet-toggle.on { border-color:rgba(255,255,255,0.2); background:var(--s3); }
.sheet-toggle .st-bar {
  width:4px; height:32px; border-radius:2px; flex-shrink:0;
  opacity:0.5; transition:opacity 0.15s;
}
.sheet-toggle.on .st-bar { opacity:1; }
.sheet-toggle .st-label {
  font-size:0.78rem; font-weight:500; color:var(--muted);
  line-height:1.25; transition:color 0.15s;
}
.sheet-toggle.on .st-label { color:var(--text); }
.sheet-toggle .st-check {
  margin-left:auto; width:18px; height:18px; border-radius:50%;
  border:1.5px solid var(--dim); flex-shrink:0;
  display:flex; align-items:center; justify-content:center;
  font-size:9px; color:transparent; transition:all 0.15s;
}
.sheet-toggle.on .st-check { background:var(--teal); border-color:var(--teal); color:var(--bg); }

/* Mobile filter trigger button above each chart */
.filter-trigger-btn {
  display:none; /* shown only on mobile via media query */
  align-items:center; gap:6px; padding:8px 14px;
  border-radius:20px; border:1px solid var(--border);
  background:var(--s1); color:var(--muted);
  font-size:0.78rem; font-weight:500; cursor:pointer;
  font-family:'Outfit',sans-serif; margin-bottom:10px;
  min-height:38px; -webkit-tap-highlight-color:transparent;
  transition:all 0.15s;
}
.filter-trigger-btn:hover { background:var(--s2); color:var(--text); }
.filter-trigger-btn .ft-count {
  background:var(--teal); color:var(--bg); border-radius:10px;
  padding:1px 7px; font-size:0.68rem; font-weight:700;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ENV CARD â€” COLLAPSED SUMMARY BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.env-summary-bar {
  display:flex; align-items:center; gap:10px;
  padding:11px 14px; border-radius:var(--rsm);
  background:var(--s1); border:1px solid var(--border);
  cursor:pointer; transition:all 0.2s; margin-bottom:4px;
  -webkit-tap-highlight-color:transparent;
}
.env-summary-bar:hover { border-color:var(--bmd); background:var(--s2); }
.env-summary-bar.loaded { border-color:rgba(92,207,190,0.25); }
.esb-icon { font-size:1.1rem; flex-shrink:0; }
.esb-content { flex:1; min-width:0; overflow:hidden; }
.esb-main { font-size:0.82rem; color:var(--text); font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.esb-sub  { font-size:0.7rem; color:var(--muted); margin-top:1px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.esb-chevron {
  font-size:0.7rem; color:var(--dim); flex-shrink:0;
  transition:transform 0.28s ease; line-height:1;
}
.esb-chevron.open { transform:rotate(180deg); }

/* Collapsible env detail panel */
.env-detail {
  overflow:hidden;
  max-height:0;
  transition:max-height 0.38s cubic-bezier(0.4,0,0.2,1), opacity 0.28s ease;
  opacity:0;
}
.env-detail.open { max-height:1200px; opacity:1; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ZIP CODE ENTRY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.zip-entry-panel {
  background:var(--s1); border:1px solid var(--border);
  border-radius:var(--rsm); padding:16px; margin-bottom:10px;
}
.zip-entry-label {
  font-size:0.72rem; color:var(--muted); margin-bottom:10px;
  display:flex; align-items:center; gap:6px;
}
.zip-row { display:flex; gap:8px; align-items:flex-start; }
.zip-input-wrap { flex:1; position:relative; }
.zip-input {
  width:100%; background:var(--s2); border:1.5px solid var(--border);
  border-radius:var(--rsm); color:var(--text);
  font-family:'JetBrains Mono',monospace; font-size:1rem;
  padding:11px 14px; outline:none; transition:border-color 0.2s;
  letter-spacing:0.05em;
}
.zip-input:focus { border-color:var(--teal); }
.zip-input.success { border-color:var(--sage); }
.zip-input.error   { border-color:var(--rose); }
.zip-feedback {
  font-size:0.72rem; margin-top:5px; min-height:18px;
  transition:all 0.2s; display:flex; align-items:center; gap:4px;
}
.zip-feedback.success { color:var(--sage); }
.zip-feedback.error   { color:var(--rose); }

/* Lookup button with state transitions */
.zip-lookup-btn {
  display:flex; align-items:center; justify-content:center; gap:6px;
  padding:11px 18px; border-radius:var(--rsm); border:none;
  background:var(--teal); color:var(--bg);
  font-family:'Outfit',sans-serif; font-size:0.88rem; font-weight:600;
  cursor:pointer; transition:all 0.22s; min-height:46px; min-width:90px;
  flex-shrink:0; -webkit-tap-highlight-color:transparent;
}
.zip-lookup-btn:hover:not(:disabled) { filter:brightness(1.1); }
.zip-lookup-btn:disabled { cursor:not-allowed; opacity:0.7; }
.zip-lookup-btn.loading { background:var(--s3); color:var(--muted); }
.zip-lookup-btn.success { background:rgba(126,201,154,0.2); color:var(--sage); border:1px solid rgba(126,201,154,0.4); }
.zip-lookup-btn.error   { background:rgba(232,119,138,0.15); color:var(--rose); border:1px solid rgba(232,119,138,0.35); }

/* Spinner */
@keyframes spin { to { transform:rotate(360deg); } }
.spinner {
  width:14px; height:14px; border-radius:50%;
  border:2px solid currentColor; border-top-color:transparent;
  animation:spin 0.7s linear infinite; flex-shrink:0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MANUAL FIELD INDICATORS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.wx-tile-wrap { position:relative; }
.manual-tag {
  position:absolute; top:4px; right:4px;
  font-size:0.58rem; font-weight:700; letter-spacing:0.06em;
  color:var(--amber); background:rgba(242,169,78,0.12);
  border:1px solid rgba(242,169,78,0.3); border-radius:4px;
  padding:1px 4px; opacity:0; transition:opacity 0.2s;
  pointer-events:none;
}
.wx-tile-wrap.overridden .manual-tag { opacity:1; }
.wx-tile-wrap.overridden .wx-input { border-color:rgba(242,169,78,0.5); }

/* Apply manual button */
.apply-manual-btn {
  display:flex; align-items:center; gap:7px;
  padding:10px 18px; border-radius:var(--rsm); border:none;
  background:var(--s2); border:1px solid var(--bmd);
  color:var(--text); font-family:'Outfit',sans-serif;
  font-size:0.85rem; font-weight:600; cursor:pointer;
  transition:all 0.22s; min-height:42px; margin-top:10px;
  -webkit-tap-highlight-color:transparent;
}
.apply-manual-btn:hover { background:var(--s3); }
.apply-manual-btn.success { border-color:rgba(126,201,154,0.4); color:var(--sage); background:rgba(126,201,154,0.08); }

.no-data { text-align:center; padding:60px 20px; color:var(--dim); }
.no-data .ndi { font-size:3rem; margin-bottom:12px; opacity:0.5; }
.no-data p { font-size:0.88rem; max-width:280px; margin:0 auto; line-height:1.7; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.drop-zone {
  border:2px dashed var(--border); border-radius:var(--radius);
  padding:32px 20px; text-align:center; cursor:pointer;
  transition:all 0.2s; color:var(--muted); font-size:0.85rem; margin-bottom:10px;
}
.drop-zone:hover,.drop-zone.drag { border-color:rgba(92,207,190,0.4); background:var(--teal-d); color:var(--teal); }
.drop-zone .dz-icon { font-size:2rem; margin-bottom:8px; display:block; }
.drop-zone .dz-hint { font-size:0.72rem; color:var(--dim); margin-top:5px; }

.data-info { background:var(--s1); border:1px solid var(--border); border-radius:var(--rsm); padding:16px; font-size:0.83rem; color:var(--muted); line-height:1.9; }
.data-info strong { color:var(--text); }

.info-banner {
  display:flex; align-items:flex-start; gap:10px;
  background:var(--teal-d); border:1px solid rgba(92,207,190,0.25);
  border-radius:var(--rsm); padding:12px 16px; font-size:0.8rem; color:var(--teal);
  line-height:1.6; margin-bottom:14px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE â€” MOBILE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width:767px) {
  .top-nav { display:none; }
  .bot-nav { display:flex; flex-direction:column; }

  body { padding-bottom:calc(var(--bot-h) + var(--safe-bot)); }

  /* wizard nav visible on mobile log page */
  .wizard-nav.visible { display:flex; }
  .wizard-progress { display:block; }

  /* float save button above bottom nav on desktop hidden on mobile (wizard handles it) */
  .sticky-save-desktop { display:none !important; }

  .container { padding:16px 12px calc(var(--bot-h) + var(--safe-bot) + 70px); }

  /* bigger check tiles */
  .check-grid { grid-template-columns:1fr 1fr; }
  .check-tile { min-height:48px; }

  /* mood grid 4-col on small */
  .mood-row { grid-template-columns:repeat(4,1fr); }
  .mood-tile .me { font-size:1.6rem; }

  .page-header h1 { font-size:1.6rem; }
  .dash-stats { grid-template-columns:repeat(3,1fr); }

  .chart-wrap { padding:14px 12px 10px; }
  .wx-grid { grid-template-columns:repeat(3,1fr); }

  /* On mobile: hide chip rows, show filter trigger buttons instead */
  .chip-row { display:none; }
  .chip-section-label { display:none; }
  .filter-trigger-btn { display:flex; }
}

@media (min-width:768px) {
  /* show sticky save on desktop log page */
  .sticky-save-desktop { display:block; }
  .wizard-nav { display:none !important; }
  /* desktop: show all steps at once */
  .wizard-step { display:block !important; }
  .wizard-progress { display:none !important; }
  .log-desktop-save { display:flex; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DESKTOP TOP NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="top-nav">
  <div class="nav-brand">FibroFlow <em>symptom tracker</em></div>
  <div class="nav-pill">
    <button class="nav-tab active" onclick="showPage('log',this)">ğŸ“ Log</button>
    <button class="nav-tab" onclick="showPage('dashboard',this)">ğŸ“Š Dashboard</button>
    <button class="nav-tab" onclick="showPage('data',this)">ğŸ’¾ Data</button>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MOBILE BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="bot-nav" id="bot-nav">
  <div class="bot-nav-inner">
    <button class="bot-tab active" id="bt-log" onclick="showPage('log',this,'bt-log')">
      <span class="bt-icon">ğŸ“</span>Log
    </button>
    <button class="bot-tab" id="bt-dashboard" onclick="showPage('dashboard',this,'bt-dashboard')">
      <span class="bt-icon">ğŸ“Š</span>Dashboard
    </button>
    <button class="bot-tab" id="bt-data" onclick="showPage('data',this,'bt-data')">
      <span class="bt-icon">ğŸ’¾</span>Data
    </button>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOG PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-log" class="page active">
<div class="container">

  <div class="page-header">
    <h1>Daily <em>Log</em></h1>
    <div class="sub" id="log-date"></div>
  </div>

  <!-- Timestamp + location banner -->
  <div class="timestamp-banner">
    <span class="ts-icon">ğŸ•</span>
    <div class="ts-content">
      <div class="ts-label">Entry will be saved at</div>
      <div class="ts-value" id="ts-live">â€”</div>
      <div class="ts-location" id="ts-location">ğŸ“ Detecting locationâ€¦</div>
    </div>
  </div>

  <!-- Location manual fallback replaced by zip entry inside env card -->

  <!-- Mobile wizard progress -->
  <div class="wizard-progress" id="wizard-progress">
    <div class="wizard-bar-wrap"><div class="wizard-bar" id="wizard-bar" style="width:16.6%"></div></div>
    <div class="wizard-meta">
      <span id="wizard-step-label">Step 1 of 6</span>
      <span id="wizard-step-name">Environment</span>
    </div>
  </div>

  <!-- â”€â”€ STEP 1: Environment â”€â”€ -->
  <div class="wizard-step active" data-step="1" data-name="Environment">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="accent-bar" style="background:var(--sky)"></div>Environmental Data</div>
        <div style="display:flex;align-items:center;gap:8px">
          <span id="zip-always-link" style="display:none;font-size:0.72rem;color:var(--teal);cursor:pointer;text-decoration:underline;text-underline-offset:2px" onclick="showZipPanel()">Enter ZIP</span>
          <button class="btn-xs btn-ghost btn" onclick="refreshWeather()">ğŸ”„</button>
        </div>
      </div>

      <!-- Summary bar â€” shown when data loaded, hidden when waiting/failed -->
      <div class="env-summary-bar loaded" id="env-summary-bar" style="display:none" onclick="toggleEnvDetail()">
        <span class="esb-icon">ğŸŒ¤ï¸</span>
        <div class="esb-content">
          <div class="esb-main" id="esb-main">Loadingâ€¦</div>
          <div class="esb-sub"  id="esb-sub">â€”</div>
        </div>
        <span class="esb-chevron" id="esb-chevron">â–¾</span>
      </div>

      <!-- Zip entry panel â€” shown only when auto-fetch fails -->
      <div id="zip-entry-panel" class="zip-entry-panel" style="display:none">
        <div class="zip-entry-label">ğŸ“ Auto-location unavailable. Enter your ZIP or postal code to load weather &amp; air quality.</div>
        <div class="zip-row">
          <div class="zip-input-wrap">
            <input class="zip-input" id="zip-input" type="text" maxlength="10"
              placeholder="e.g. 33101" autocomplete="postal-code"
              onkeydown="if(event.key==='Enter')lookupZip()">
            <div class="zip-feedback" id="zip-feedback"></div>
          </div>
          <button class="zip-lookup-btn" id="zip-lookup-btn" onclick="lookupZip()">Look up â†’</button>
        </div>
      </div>

      <!-- Status bar (shown while fetching) -->
      <div class="wx-status" id="wx-status" style="display:none">
        <span>ğŸ“</span><span id="wx-status-text">Fetching locationâ€¦</span>
      </div>

      <!-- Collapsible detail panel â€” hidden on success, shown on desktop by default -->
      <div class="env-detail" id="env-detail">

        <!-- Weather tiles -->
        <div class="wx-grid" id="wx-auto" style="margin-top:10px">
          <div class="wx-tile"><div class="wx-icon">ğŸŒ¡ï¸</div><div class="wx-lbl">Temp</div><div class="wx-val empty" id="wd-temp">â€”</div></div>
          <div class="wx-tile"><div class="wx-icon">ğŸ’§</div><div class="wx-lbl">Humidity</div><div class="wx-val empty" id="wd-hum">â€”</div></div>
          <div class="wx-tile"><div class="wx-icon">ğŸŒ§ï¸</div><div class="wx-lbl">Precip</div><div class="wx-val empty" id="wd-precip">â€”</div></div>
          <div class="wx-tile"><div class="wx-icon">ğŸ“Š</div><div class="wx-lbl">Pressure</div><div class="wx-val empty" id="wd-pres">â€”</div></div>
          <div class="wx-tile"><div class="wx-icon">ğŸ’¨</div><div class="wx-lbl">Wind</div><div class="wx-val empty" id="wd-wind">â€”</div></div>
          <div class="wx-tile"><div class="wx-icon">â˜ï¸</div><div class="wx-lbl">Cloud</div><div class="wx-val empty" id="wd-cloud">â€”</div></div>
          <div class="wx-tile"><div class="wx-icon">ğŸŒ•</div><div class="wx-lbl">Moon</div><div class="wx-val empty" id="wd-moon">â€”</div></div>
          <div class="wx-tile"><div class="wx-icon">â›°ï¸</div><div class="wx-lbl">Altitude</div><div class="wx-val empty" id="wd-alt">â€”</div></div>
        </div>

        <!-- Air Quality section -->
        <div class="aq-divider">Air Quality <span id="aq-status-label" style="font-size:0.65rem;font-weight:400;font-style:italic;color:var(--muted)">fetchingâ€¦</span></div>
        <div class="wx-grid">
          <div class="wx-tile" style="grid-column:span 2">
            <div class="wx-icon">ğŸŒ«ï¸</div>
            <div class="wx-lbl">US AQI</div>
            <div class="wx-val empty" id="wd-aqi" style="flex-direction:column;gap:3px">â€”</div>
          </div>
          <div class="wx-tile"><div class="wx-icon">ğŸ”¬</div><div class="wx-lbl">PM2.5 Î¼g/mÂ³</div><div class="wx-val empty" id="wd-pm25">â€”</div></div>
          <div class="wx-tile"><div class="wx-icon">ğŸ’¨</div><div class="wx-lbl">PM10 Î¼g/mÂ³</div><div class="wx-val empty" id="wd-pm10">â€”</div></div>
          <div class="wx-tile"><div class="wx-icon">âš—ï¸</div><div class="wx-lbl">Ozone Î¼g/mÂ³</div><div class="wx-val empty" id="wd-o3">â€”</div></div>
          <div class="wx-tile"><div class="wx-icon">ğŸ­</div><div class="wx-lbl">NOâ‚‚ Î¼g/mÂ³</div><div class="wx-val empty" id="wd-no2">â€”</div></div>
        </div>

        <!-- Manual override panel -->
        <div style="margin-top:10px">
          <button class="btn btn-ghost btn-xs" id="manual-toggle-btn" onclick="toggleManual()" style="margin-bottom:8px">âœï¸ Override values manually</button>
          <div class="manual-panel" id="manual-panel">
            <div style="font-size:0.72rem;color:var(--muted);margin-bottom:10px;font-style:italic;">These values override auto-fetched data for this entry only.</div>
            <div class="wx-grid">
              <div class="wx-tile wx-tile-wrap" id="wrap-wm-temp"><div class="wx-icon">ğŸŒ¡ï¸</div><div class="wx-lbl">Temp Â°F</div><input class="wx-input" id="wm-temp" type="number" placeholder="72" oninput="markManual('wm-temp','wrap-wm-temp')"><span class="manual-tag">MANUAL</span></div>
              <div class="wx-tile wx-tile-wrap" id="wrap-wm-hum"><div class="wx-icon">ğŸ’§</div><div class="wx-lbl">Humidity %</div><input class="wx-input" id="wm-hum" type="number" placeholder="60" oninput="markManual('wm-hum','wrap-wm-hum')"><span class="manual-tag">MANUAL</span></div>
              <div class="wx-tile wx-tile-wrap" id="wrap-wm-precip"><div class="wx-icon">ğŸŒ§ï¸</div><div class="wx-lbl">Precip in</div><input class="wx-input" id="wm-precip" type="number" step="0.01" placeholder="0.2" oninput="markManual('wm-precip','wrap-wm-precip')"><span class="manual-tag">MANUAL</span></div>
              <div class="wx-tile wx-tile-wrap" id="wrap-wm-pres"><div class="wx-icon">ğŸ“Š</div><div class="wx-lbl">Pressure hPa</div><input class="wx-input" id="wm-pres" type="number" placeholder="1013" oninput="markManual('wm-pres','wrap-wm-pres')"><span class="manual-tag">MANUAL</span></div>
              <div class="wx-tile wx-tile-wrap" id="wrap-wm-wind"><div class="wx-icon">ğŸ’¨</div><div class="wx-lbl">Wind mph</div><input class="wx-input" id="wm-wind" type="number" placeholder="10" oninput="markManual('wm-wind','wrap-wm-wind')"><span class="manual-tag">MANUAL</span></div>
              <div class="wx-tile wx-tile-wrap" id="wrap-wm-cloud"><div class="wx-icon">â˜ï¸</div><div class="wx-lbl">Cloud %</div><input class="wx-input" id="wm-cloud" type="number" placeholder="40" oninput="markManual('wm-cloud','wrap-wm-cloud')"><span class="manual-tag">MANUAL</span></div>
              <div class="wx-tile wx-tile-wrap" id="wrap-wm-alt"><div class="wx-icon">â›°ï¸</div><div class="wx-lbl">Altitude m</div><input class="wx-input" id="wm-alt" type="number" placeholder="300" oninput="markManual('wm-alt','wrap-wm-alt')"><span class="manual-tag">MANUAL</span></div>
              <div class="wx-tile wx-tile-wrap" id="wrap-wm-aqi"><div class="wx-icon">ğŸŒ«ï¸</div><div class="wx-lbl">AQI</div><input class="wx-input" id="wm-aqi" type="number" placeholder="50" oninput="markManual('wm-aqi','wrap-wm-aqi')"><span class="manual-tag">MANUAL</span></div>
              <div class="wx-tile wx-tile-wrap" id="wrap-wm-pm25"><div class="wx-icon">ğŸ”¬</div><div class="wx-lbl">PM2.5</div><input class="wx-input" id="wm-pm25" type="number" placeholder="12" oninput="markManual('wm-pm25','wrap-wm-pm25')"><span class="manual-tag">MANUAL</span></div>
              <div class="wx-tile wx-tile-wrap" id="wrap-wm-pm10"><div class="wx-icon">ğŸ’¨</div><div class="wx-lbl">PM10</div><input class="wx-input" id="wm-pm10" type="number" placeholder="20" oninput="markManual('wm-pm10','wrap-wm-pm10')"><span class="manual-tag">MANUAL</span></div>
              <div class="wx-tile wx-tile-wrap" id="wrap-wm-o3"><div class="wx-icon">âš—ï¸</div><div class="wx-lbl">Ozone</div><input class="wx-input" id="wm-o3" type="number" placeholder="80" oninput="markManual('wm-o3','wrap-wm-o3')"><span class="manual-tag">MANUAL</span></div>
              <div class="wx-tile wx-tile-wrap" id="wrap-wm-no2"><div class="wx-icon">ğŸ­</div><div class="wx-lbl">NOâ‚‚</div><input class="wx-input" id="wm-no2" type="number" placeholder="15" oninput="markManual('wm-no2','wrap-wm-no2')"><span class="manual-tag">MANUAL</span></div>
            </div>
            <button class="apply-manual-btn" id="apply-manual-btn" onclick="applyManualValues()">âœ“ Apply manual values</button>
          </div>
        </div>

      </div><!-- end env-detail -->
    </div>
  </div>

  <!-- â”€â”€ STEP 2: Where & How it Hurts (merged pain location + type) â”€â”€ -->
  <div class="wizard-step" data-step="2" data-name="Where & How it Hurts">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="accent-bar" style="background:var(--rose)"></div>Where does it hurt?</div>
        <button class="none-today-btn" onclick="noneToday('cg-locations')">âœ• None today</button>
      </div>
      <div class="check-grid" id="cg-locations">
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Head / Migraines</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Neck &amp; Shoulders</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Upper Back</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Lower Back</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Chest / Ribs</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Arms / Elbows</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Hands / Wrists</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Hips / Pelvis</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Legs / Knees</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Feet / Ankles</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Widespread / All Over</div>
      </div>

      <hr class="divider">

      <div class="card-header" style="margin-bottom:10px">
        <div class="card-title"><div class="accent-bar" style="background:var(--rose)"></div>Type of pain</div>
        <button class="none-today-btn" onclick="noneToday('cg-paintypes')">âœ• None today</button>
      </div>
      <div class="check-grid" id="cg-paintypes">
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Burning</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Stabbing</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Aching / Dull</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Throbbing</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Shooting</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Tingling / Pins &amp; Needles</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Numbness</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Muscle Spasms</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Deep Aching Tenderness</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Stiffness</div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ STEP 3: Pain Scores â”€â”€ -->
  <div class="wizard-step" data-step="3" data-name="Pain Scores">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="accent-bar" style="background:var(--rose)"></div>Rate your physical symptoms</div>
      </div>
      <div id="sg-pain-overall" class="scale-group">
        <div class="scale-head"><span class="scale-name">Overall Pain Level</span><span class="scale-badge" id="sb-pain-overall">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-pain-overall" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('pain-overall',this.value)"></div>
        <div class="scale-hints"><span>No pain at all</span><span>Crying, unbearable</span></div>
      </div>
      <div id="sg-fatigue" class="scale-group">
        <div class="scale-head"><span class="scale-name">Fatigue / Exhaustion</span><span class="scale-badge" id="sb-fatigue">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-fatigue" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('fatigue',this.value)"></div>
        <div class="scale-hints"><span>Full of energy</span><span>Completely exhausted</span></div>
      </div>
      <div id="sg-stiffness" class="scale-group">
        <div class="scale-head"><span class="scale-name">Body Stiffness</span><span class="scale-badge" id="sb-stiffness">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-stiffness" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('stiffness',this.value)"></div>
        <div class="scale-hints"><span>Flexible &amp; loose</span><span>Cannot move freely</span></div>
      </div>
      <div id="sg-sleep" class="scale-group">
        <div class="scale-head"><span class="scale-name">Sleep Quality (last night)</span><span class="scale-badge" id="sb-sleep">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-sleep" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('sleep',this.value)"></div>
        <div class="scale-hints"><span>Slept perfectly</span><span>No sleep at all</span></div>
      </div>
      <div id="sg-brainfog" class="scale-group">
        <div class="scale-head"><span class="scale-name">Brain Fog / Fibro Fog</span><span class="scale-badge" id="sb-brainfog">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-brainfog" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('brainfog',this.value)"></div>
        <div class="scale-hints"><span>Thinking clearly</span><span>Severely foggy</span></div>
      </div>
      <div id="sg-sensitivity" class="scale-group">
        <div class="scale-head"><span class="scale-name">Sensory Sensitivity</span><span class="scale-badge" id="sb-sensitivity">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-sensitivity" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('sensitivity',this.value)"></div>
        <div class="scale-hints"><span>Normal sensitivity</span><span>Extremely sensitive</span></div>
      </div>
      <div id="sg-flare" class="scale-group">
        <div class="scale-head"><span class="scale-name">Flare-Up Severity</span><span class="scale-badge" id="sb-flare">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-flare" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('flare',this.value)"></div>
        <div class="scale-hints"><span>No flare-up</span><span>Severe flare-up</span></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ STEP 4: Mood & Mental Health (merged) â”€â”€ -->
  <div class="wizard-step" data-step="4" data-name="Mood & Mental Health">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="accent-bar" style="background:var(--lavender)"></div>How are you feeling?</div>
      </div>
      <div class="mood-row" id="mood-row">
        <div class="mood-tile" onclick="pickMood(this,'happy')"><span class="me">ğŸ˜Š</span><span class="ml">Happy</span></div>
        <div class="mood-tile" onclick="pickMood(this,'calm')"><span class="me">ğŸ˜Œ</span><span class="ml">Calm</span></div>
        <div class="mood-tile" onclick="pickMood(this,'hopeful')"><span class="me">ğŸŒŸ</span><span class="ml">Hopeful</span></div>
        <div class="mood-tile" onclick="pickMood(this,'grateful')"><span class="me">ğŸ™</span><span class="ml">Grateful</span></div>
        <div class="mood-tile" onclick="pickMood(this,'neutral')"><span class="me">ğŸ˜</span><span class="ml">Neutral</span></div>
        <div class="mood-tile" onclick="pickMood(this,'tired')"><span class="me">ğŸ˜´</span><span class="ml">Tired</span></div>
        <div class="mood-tile" onclick="pickMood(this,'sad')"><span class="me">ğŸ˜¢</span><span class="ml">Sad</span></div>
        <div class="mood-tile" onclick="pickMood(this,'anxious')"><span class="me">ğŸ˜°</span><span class="ml">Anxious</span></div>
        <div class="mood-tile" onclick="pickMood(this,'overwhelmed')"><span class="me">ğŸ˜µ</span><span class="ml">Overwhelmed</span></div>
        <div class="mood-tile" onclick="pickMood(this,'frustrated')"><span class="me">ğŸ˜ </span><span class="ml">Frustrated</span></div>
        <div class="mood-tile" onclick="pickMood(this,'depressed')"><span class="me">ğŸŒ§ï¸</span><span class="ml">Depressed</span></div>
        <div class="mood-tile" onclick="pickMood(this,'lonely')"><span class="me">ğŸ•Šï¸</span><span class="ml">Lonely</span></div>
      </div>

      <hr class="divider">

      <div class="card-header" style="margin-bottom:14px">
        <div class="card-title"><div class="accent-bar" style="background:var(--lavender)"></div>Mental &amp; Emotional State</div>
      </div>
      <div id="sg-depression" class="scale-group">
        <div class="scale-head"><span class="scale-name">Depression Level</span><span class="scale-badge" id="sb-depression">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-depression" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('depression',this.value)"></div>
        <div class="scale-hints"><span>Not at all</span><span>Severely depressed</span></div>
      </div>
      <div id="sg-anxiety" class="scale-group">
        <div class="scale-head"><span class="scale-name">Anxiety Level</span><span class="scale-badge" id="sb-anxiety">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-anxiety" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('anxiety',this.value)"></div>
        <div class="scale-hints"><span>Feeling at peace</span><span>Severe anxiety</span></div>
      </div>
      <div id="sg-stress" class="scale-group">
        <div class="scale-head"><span class="scale-name">Stress Level</span><span class="scale-badge" id="sb-stress">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-stress" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('stress',this.value)"></div>
        <div class="scale-hints"><span>No stress</span><span>Extreme stress</span></div>
      </div>
      <div id="sg-overwhelm" class="scale-group">
        <div class="scale-head"><span class="scale-name">Feeling Overwhelmed</span><span class="scale-badge" id="sb-overwhelm">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-overwhelm" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('overwhelm',this.value)"></div>
        <div class="scale-hints"><span>Coping well</span><span>Completely overwhelmed</span></div>
      </div>
      <div id="sg-isolation" class="scale-group">
        <div class="scale-head"><span class="scale-name">Social Isolation</span><span class="scale-badge" id="sb-isolation">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-isolation" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('isolation',this.value)"></div>
        <div class="scale-hints"><span>Socially engaged</span><span>Fully withdrawn</span></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ STEP 5: Other Symptoms â”€â”€ -->
  <div class="wizard-step" data-step="5" data-name="Other Symptoms">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="accent-bar" style="background:var(--sage)"></div>Other Symptoms &amp; Wellbeing</div>
        <button class="none-today-btn" onclick="noneToday('cg-other')">âœ• None today</button>
      </div>
      <div class="check-grid" id="cg-other">
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Nausea</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Digestive / IBS</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Dizziness / Vertigo</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Heart Palpitations</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>TMJ / Jaw Pain</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Restless Legs</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Dry Eyes / Mouth</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Temperature Issues</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Swelling / Puffiness</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Skin Sensitivity</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Headache</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Vision Changes</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Tinnitus</div>
        <div class="check-tile" onclick="toggleTile(this)"><div class="check-box">âœ“</div>Cognitive Confusion</div>
      </div>
      <hr class="divider">
      <div id="sg-activity" class="scale-group">
        <div class="scale-head"><span class="scale-name">Activity Level Today</span><span class="scale-badge" id="sb-activity">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-activity" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('activity',this.value)"></div>
        <div class="scale-hints"><span>Very active</span><span>Bed-bound all day</span></div>
      </div>
      <div id="sg-medication" class="scale-group">
        <div class="scale-head"><span class="scale-name">Medication Effectiveness</span><span class="scale-badge" id="sb-medication">â€”</span></div>
        <div class="slider-wrap"><input class="scale-slider" id="sl-medication" type="range" min="0" max="10" step="1" value="0" oninput="pickSlider('medication',this.value)"></div>
        <div class="scale-hints"><span>Very effective</span><span>No relief at all</span></div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ STEP 6: Notes & Save â”€â”€ -->
  <div class="wizard-step" data-step="6" data-name="Notes & Save">
    <div class="card">
      <div class="card-header">
        <div class="card-title"><div class="accent-bar" style="background:var(--amber)"></div>Journal / Notes</div>
      </div>
      <textarea class="fibro-textarea" id="daily-notes" placeholder="How are you feeling overall? Any triggers, changes, or observationsâ€¦"></textarea>
    </div>
    <div class="btn-row log-desktop-save">
      <button class="btn btn-primary" onclick="saveEntry()">ğŸ’¾ Save &amp; Download</button>
      <button class="btn btn-ghost btn-sm" onclick="resetForm()">â†© Reset</button>
    </div>
  </div>

</div>
</div>

<!-- Floating desktop save button -->
<button class="btn btn-primary sticky-save-desktop" id="sticky-save-desktop" onclick="saveEntry()" style="display:none;">
  ğŸ’¾ Save &amp; Download
</button>

<!-- Same as yesterday shortcut (shown only when previous entry exists) -->
<div class="shortcut-row" id="yesterday-row" style="display:none">
  <button class="shortcut-btn yesterday" onclick="sameAsYesterday()">ğŸ“‹ Same as yesterday</button>
  <button class="shortcut-btn" onclick="resetForm()">â†© Start fresh</button>
</div>

<!-- Bottom sheet backdrop -->
<div class="sheet-backdrop" id="sheet-backdrop" onclick="closeSheet()"></div>

<!-- Bottom sheet (single, content swapped per chart) -->
<div class="bottom-sheet" id="bottom-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <span class="sheet-title" id="sheet-title">Filters</span>
    <button class="sheet-done" onclick="closeSheet()">Done</button>
  </div>
  <div class="sheet-body">
    <div class="sheet-toggle-grid" id="sheet-toggle-grid"></div>
  </div>
</div>

<!-- Mobile wizard navigation -->
<div class="wizard-nav" id="wizard-nav">
  <button class="btn btn-ghost" style="flex:1" id="wiz-back" onclick="wizardBack()">â† Back</button>
  <button class="btn btn-primary" style="flex:2" id="wiz-next" onclick="wizardNext()">Next â†’</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DASHBOARD PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-dashboard" class="page">
<div class="container">

  <div class="page-header">
    <h1><em>Dashboard</em></h1>
    <div class="sub">Symptoms &amp; environment over time</div>
  </div>

  <div id="dash-no-data" class="no-data">
    <div class="ndi">ğŸŒ¿</div>
    <p>No entries yet. Start logging in the Log tab and your trends will appear here.</p>
    <button class="btn btn-ghost btn-sm" style="margin-top:18px" onclick="loadDemoData()">âœ¨ Load demo data</button>
  </div>

  <div id="dash-content" style="display:none">

    <div class="dash-stats" id="dash-stats"></div>

    <!-- Controls -->
    <div class="dash-controls">
      <div class="ctrl-group">
        <span class="ctrl-label">Range</span>
        <select class="ctrl-select" id="range-sel" onchange="onRangeChange()">
          <option value="7">Last 7 days</option>
          <option value="14">Last 14 days</option>
          <option value="30" selected>Last 30 days</option>
          <option value="60">Last 60 days</option>
          <option value="90">Last 90 days</option>
          <option value="0">All time</option>
          <option value="custom">Custom rangeâ€¦</option>
        </select>
      </div>
      <div class="ctrl-group">
        <span class="ctrl-label">Session</span>
        <select class="ctrl-select" id="session-sel" onchange="renderDash()">
          <option value="all">All sessions</option>
          <option value="morning">Morning (6amâ€“12pm)</option>
          <option value="afternoon">Afternoon (12pmâ€“6pm)</option>
          <option value="evening">Evening (6pmâ€“12am)</option>
        </select>
      </div>
    </div>

    <!-- Custom date range -->
    <div class="date-range-row" id="date-range-row">
      <div class="ctrl-group">
        <span class="ctrl-label">From</span>
        <input type="date" class="date-input" id="date-from" onchange="renderDash()">
      </div>
      <div class="ctrl-group">
        <span class="ctrl-label">To</span>
        <input type="date" class="date-input" id="date-to" onchange="renderDash()">
      </div>
      <button class="btn btn-ghost btn-sm" onclick="applyCustomRange()">Apply</button>
    </div>

    <!-- Filter chips (desktop) + Filter trigger buttons (mobile) -->
    <div style="margin-bottom:4px">
      <div class="chip-section-label">Physical Symptoms</div>
      <button class="filter-trigger-btn" onclick="openSheet('physical')" id="ftb-physical">
        âš™ Filters â€” Physical <span class="ft-count" id="ftc-physical">0</span>
      </button>
      <div class="chip-row" id="chips-physical"></div>

      <div class="chip-section-label">Mental &amp; Emotional</div>
      <button class="filter-trigger-btn" onclick="openSheet('mental')" id="ftb-mental">
        âš™ Filters â€” Mental <span class="ft-count" id="ftc-mental">0</span>
      </button>
      <div class="chip-row" id="chips-mental"></div>

      <div class="chip-section-label">Environmental</div>
      <button class="filter-trigger-btn" onclick="openSheet('env')" id="ftb-env">
        âš™ Filters â€” Environmental <span class="ft-count" id="ftc-env">0</span>
      </button>
      <div class="chip-row" id="chips-env"></div>
    </div>

    <!-- Charts -->
    <div style="margin-top:18px">

      <div class="chart-wrap">
        <div class="chart-header">
          <div>
            <div class="chart-label"><div class="accent-bar" style="background:var(--rose)"></div>Physical Symptoms</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="chart-meta">1 = none Â· 10 = severe</span>
            <button class="fill-toggle-btn" id="fill-physical" onclick="toggleFill('physical')">Fill off</button>
          </div>
        </div>
        <div id="legend-physical" class="chart-legend"></div>
        <canvas id="chart-physical" height="150"></canvas>
      </div>

      <div class="chart-wrap">
        <div class="chart-header">
          <div>
            <div class="chart-label"><div class="accent-bar" style="background:var(--lavender)"></div>Mental &amp; Emotional</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="chart-meta">1 = none Â· 10 = severe</span>
            <button class="fill-toggle-btn" id="fill-mental" onclick="toggleFill('mental')">Fill off</button>
          </div>
        </div>
        <div id="legend-mental" class="chart-legend"></div>
        <canvas id="chart-mental" height="130"></canvas>
      </div>

      <div class="chart-wrap">
        <div class="chart-header">
          <div>
            <div class="chart-label"><div class="accent-bar" style="background:var(--sky)"></div>Environmental Conditions</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <span class="chart-meta">pressure normalized</span>
            <button class="fill-toggle-btn" id="fill-env" onclick="toggleFill('env')">Fill off</button>
          </div>
        </div>
        <div id="legend-env" class="chart-legend"></div>
        <canvas id="chart-env" height="120"></canvas>
      </div>

      <div class="chart-wrap" style="border-color:rgba(255,255,255,0.13)">
        <div class="chart-header">
          <div>
            <div class="chart-label"><div class="accent-bar" style="background:linear-gradient(180deg,var(--teal),var(--rose))"></div>All Data â€” Overlay</div>
            <div style="font-size:0.72rem;color:var(--muted);margin-top:3px;">Every active metric Â· symptoms left Â· environmental right</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <button class="fill-toggle-btn" id="fill-overlay" onclick="toggleFill('overlay')">Fill off</button>
          </div>
        </div>
        <div id="legend-overlay" class="chart-legend" style="max-height:72px;overflow-y:auto"></div>
        <canvas id="chart-overlay" height="200"></canvas>
        <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:0.62rem;color:var(--dim);font-family:'JetBrains Mono',monospace">
          <span>â† Symptom score (0â€“10)</span><span>Environmental â†’</span>
        </div>
      </div>

    </div>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DATA PAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-data" class="page">
<div class="container">

  <div class="page-header">
    <h1>Your <em>Data</em></h1>
    <div class="sub">Import, export, and manage records</div>
  </div>

  <div class="info-banner">
    <span style="font-size:1rem;flex-shrink:0">ğŸ”’</span>
    <span>Data lives <strong>on your device only</strong>. Each save downloads an updated file. Re-import it next session to restore your history.</span>
  </div>

  <div class="card">
    <div class="card-header"><div class="card-title"><div class="accent-bar" style="background:var(--sky)"></div>Import Data</div></div>
    <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-inp').click()">
      <span class="dz-icon">ğŸ“‚</span>
      Click or drag your FibroFlow file here
      <span class="dz-hint">Accepts .json or .csv</span>
    </div>
    <input type="file" id="file-inp" accept=".json,.csv" style="display:none" onchange="importFile(event)">
  </div>

  <div class="card">
    <div class="card-header"><div class="card-title"><div class="accent-bar" style="background:var(--sage)"></div>Export Data</div></div>
    <p style="font-size:0.82rem;color:var(--muted);margin-bottom:16px;line-height:1.7">
      <strong style="color:var(--text)">JSON</strong> â€” Full fidelity, re-importable into FibroFlow.<br>
      <strong style="color:var(--text)">CSV</strong> â€” Open in Excel or Google Sheets for custom analysis.
    </p>
    <div class="btn-row">
      <button class="btn btn-primary" onclick="exportJSON()">â¬‡ï¸ Export JSON</button>
      <button class="btn btn-ghost btn-sm" onclick="exportCSV()">ğŸ“Š Export CSV</button>
    </div>
  </div>

  <div class="card">
    <div class="card-header"><div class="card-title"><div class="accent-bar"></div>Session Summary</div></div>
    <div class="data-info" id="data-summary">No entries logged yet.</div>
  </div>

  <div class="card">
    <div class="card-header"><div class="card-title"><div class="accent-bar" style="background:var(--rose)"></div>Danger Zone</div></div>
    <p style="font-size:0.82rem;color:var(--muted);margin-bottom:14px">Clear in-session data. Does not affect exported files.</p>
    <button class="btn btn-danger btn-sm" onclick="clearAll()">ğŸ—‘ï¸ Clear Session Data</button>
  </div>

</div>
</div>

<div class="toast" id="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     JAVASCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONSTANTS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SLIDER_IDS = [
  'pain-overall','fatigue','stiffness','sleep','brainfog','sensitivity','flare',
  'depression','anxiety','stress','overwhelm','isolation',
  'activity','medication'
];

const FILTER_CFG = [
  { key:'painOverall', label:'Overall Pain',        color:'#e8778a', group:'physical' },
  { key:'fatigue',     label:'Fatigue',             color:'#f2a94e', group:'physical' },
  { key:'stiffness',   label:'Stiffness',           color:'#fbbf24', group:'physical' },
  { key:'brainfog',    label:'Brain Fog',           color:'#9f8fe8', group:'physical' },
  { key:'sleep',       label:'Sleep Quality',       color:'#6ab0f5', group:'physical' },
  { key:'sensitivity', label:'Sensory Sensitivity', color:'#c084fc', group:'physical' },
  { key:'flare',       label:'Flare-Up',            color:'#f87171', group:'physical' },
  { key:'activity',    label:'Activity Level',      color:'#94a3b8', group:'physical' },
  { key:'depression',  label:'Depression',          color:'#818cf8', group:'mental'   },
  { key:'anxiety',     label:'Anxiety',             color:'#5ccfbe', group:'mental'   },
  { key:'stress',      label:'Stress',              color:'#7ec99a', group:'mental'   },
  { key:'overwhelm',   label:'Overwhelm',           color:'#2dd4bf', group:'mental'   },
  { key:'isolation',   label:'Social Isolation',    color:'#a5b4fc', group:'mental'   },
  { key:'temp',        label:'Temperature',         color:'#fb923c', group:'env', raw:'tempRaw'      },
  { key:'humidity',    label:'Humidity',            color:'#38bdf8', group:'env', raw:'humidityRaw'  },
  { key:'pressure',    label:'Pressure',            color:'#a3e635', group:'env', raw:'pressureRaw'  },
  { key:'precip',      label:'Precipitation',       color:'#7dd3fc', group:'env', raw:'precipRaw'    },
];

const TOTAL_STEPS = 6;

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   STATE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let appData       = { entries: [] };
let selectedMood  = '';
let weatherData   = {};
let aqData        = {};
let locationData  = {};
let manualOpen    = false;
let fileHandle    = null; // File System Access API handle
let currentStep   = 1;
let isMobile      = () => window.innerWidth < 768;

let filters = {};
FILTER_CFG.forEach(f => filters[f.key] = !f.group.startsWith('env'));

let fillState = { physical:false, mental:false, env:false, overlay:false };
let charts    = {};

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   INIT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.addEventListener('load', () => {
  startClock();
  initEnvChain();   // unified: GPS â†’ IP â†’ zip panel (also fires weather)
  restoreSession();
  updateYesterdayBtn();
  updateSummary();
  initWizard();
  handleDesktopSave();
});

window.addEventListener('resize', handleDesktopSave);

function handleDesktopSave() {
  const btn = document.getElementById('sticky-save-desktop');
  const logActive = document.getElementById('page-log').classList.contains('active');
  if (btn) btn.style.display = (!isMobile() && logActive) ? 'block' : 'none';
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LIVE CLOCK
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function startClock() {
  function tick() {
    const now = new Date();
    document.getElementById('log-date').textContent = now.toLocaleDateString('en-US',{ weekday:'long', year:'numeric', month:'long', day:'numeric' });
    document.getElementById('ts-live').textContent  = now.toLocaleString('en-US',{ month:'short', day:'numeric', year:'numeric', hour:'numeric', minute:'2-digit', second:'2-digit', hour12:true });
  }
  tick();
  setInterval(tick, 1000);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   UNIFIED ENV CHAIN  GPS â†’ IP â†’ Zip panel
   One function starts everything. No parallel races.
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initEnvChain() {
  setLocationText('ğŸ“ Detecting locationâ€¦');
  showWxStatus(true);
  setWxStatus('Requesting locationâ€¦');
  hideEnvSummary();

  // Always show the zip panel link immediately so user can skip auto-detect
  document.getElementById('zip-always-link').style.display = 'inline';

  if (!navigator.geolocation) {
    fallbackToIP();
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos => onGPSSuccess(pos.coords.latitude, pos.coords.longitude, pos.coords.altitude),
    ()  => fallbackToIP(),
    { timeout: 7000, maximumAge: 300000 }
  );
}

async function onGPSSuccess(lat, lon, altitude) {
  locationData = { lat, lon, source: 'gps' };
  // Reverse geocode for display name â€” non-blocking, best effort
  try {
    const r = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`,
      { headers: { 'Accept-Language': 'en' } });
    const d = await r.json();
    const city   = d.address?.city || d.address?.town || d.address?.village || '';
    const region = d.address?.state || '';
    const country= d.address?.country || '';
    locationData = { ...locationData, city, region, country,
      display: [city, region, country].filter(Boolean).join(', ') };
    setLocationText('ğŸ“ ' + (locationData.display || coordStr(lat, lon)));
  } catch {
    locationData.display = coordStr(lat, lon);
    setLocationText('ğŸ“ ' + coordStr(lat, lon));
  }
  fetchWeatherCoords(lat, lon, altitude);
}

async function fallbackToIP() {
  try {
    const r = await fetch('https://ip-api.com/json/?fields=city,regionName,country,lat,lon,status',
      { signal: AbortSignal.timeout(6000) });
    const d = await r.json();
    if (d.status === 'success' && d.lat && d.lon) {
      locationData = { lat: d.lat, lon: d.lon, city: d.city, region: d.regionName,
        country: d.country, display: `${d.city}, ${d.regionName}`, source: 'ip' };
      setLocationText('ğŸ“ ' + locationData.display + ' (via IP)');
      fetchWeatherCoords(d.lat, d.lon, null);
      return;
    }
    throw new Error('ip failed');
  } catch {
    onAllAutoFailed();
  }
}

function onAllAutoFailed() {
  showWxStatus(false);
  showZipPanel();
  setLocationText('ğŸ“ Auto-detection unavailable â€” enter ZIP below');
}

function coordStr(lat, lon) { return `${lat.toFixed(3)}, ${lon.toFixed(3)}`; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ZIP LOOKUP  Census â†’ Nominatim fallback
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showZipPanel() {
  document.getElementById('zip-entry-panel').style.display = 'block';
  document.getElementById('env-summary-bar').style.display = 'none';
  openEnvDetail();
  // Focus input after short delay (mobile keyboard)
  setTimeout(() => document.getElementById('zip-input')?.focus(), 300);
}

function hideZipPanel() {
  document.getElementById('zip-entry-panel').style.display = 'none';
}

async function lookupZip() {
  const raw = document.getElementById('zip-input').value.trim();
  if (!raw) {
    setZipState('error', 'âœ— Please enter a ZIP or postal code');
    return;
  }

  setZipState('loading', 'Searchingâ€¦');
  let lat, lon, city, region, country, display;
  let found = false;

  /* â”€â”€ Attempt 1: US Census Geocoder (US 5-digit zips, no CORS issues) â”€â”€ */
  if (/^\d{5}$/.test(raw)) {
    try {
      const url = `https://geocoding.geo.census.gov/geocoder/locations/address?` +
        `street=&city=&state=&zip=${raw}&benchmark=Public_AR_Current&format=json`;
      const r = await fetch(url, { signal: AbortSignal.timeout(8000) });
      if (r.ok) {
        const d = await r.json();
        const match = d.result?.addressMatches?.[0];
        if (match) {
          lon = match.coordinates.x;
          lat = match.coordinates.y;
          // Census returns a match â€” get city/state from the address string
          const parts = (match.matchedAddress || '').split(',');
          city   = parts[0]?.trim() || raw;
          region = parts[parts.length - 2]?.trim() || '';
          country= 'United States';
          display= [city, region, 'US'].filter(Boolean).join(', ');
          found  = true;
        }
      }
    } catch { /* network blocked or timeout â€” fall through */ }
  }

  /* â”€â”€ Attempt 2: Nominatim postal code search (global, good CORS) â”€â”€ */
  if (!found) {
    try {
      const isUS = /^\d{5}(-\d{4})?$/.test(raw);
      const qParam = isUS
        ? `postalcode=${encodeURIComponent(raw)}&countrycodes=us`
        : `postalcode=${encodeURIComponent(raw)}`;
      const r = await fetch(
        `https://nominatim.openstreetmap.org/search?${qParam}&format=json&limit=1&addressdetails=1`,
        { headers: { 'Accept-Language': 'en' }, signal: AbortSignal.timeout(8000) }
      );
      const d = await r.json();
      if (d?.length) {
        lat    = parseFloat(d[0].lat);
        lon    = parseFloat(d[0].lon);
        const a = d[0].address || {};
        city   = a.city || a.town || a.village || a.municipality || raw;
        region = a.state || a.county || '';
        country= a.country || '';
        display= [city, region, country].filter(Boolean).join(', ');
        found  = true;
      }
    } catch { /* fall through */ }
  }

  /* â”€â”€ Attempt 3: Open-Meteo geocoding API (weather-focused, reliable CORS) â”€â”€ */
  if (!found) {
    try {
      const r = await fetch(
        `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(raw)}&count=1&language=en&format=json`,
        { signal: AbortSignal.timeout(8000) }
      );
      const d = await r.json();
      const res = d.results?.[0];
      if (res) {
        lat    = res.latitude;
        lon    = res.longitude;
        city   = res.name || raw;
        region = res.admin1 || '';
        country= res.country || '';
        display= [city, region, country].filter(Boolean).join(', ');
        found  = true;
      }
    } catch { /* all attempts failed */ }
  }

  if (!found) {
    setZipState('error', `âœ— "${raw}" not found â€” check the code and try again`);
    return;
  }

  // SUCCESS
  locationData = { lat, lon, city, region, country, display, zip: raw, source: 'zip' };
  setLocationText('ğŸ“ ' + display);
  setZipState('success', `âœ“ ${display} â€” loading weatherâ€¦`);

  await fetchWeatherCoords(lat, lon, null);

  hideZipPanel();
  setZipState('idle', '');
}

function setZipState(state, feedback) {
  const btn = document.getElementById('zip-lookup-btn');
  const inp = document.getElementById('zip-input');
  const fb  = document.getElementById('zip-feedback');
  if (!btn) return;

  btn.disabled = state === 'loading';
  btn.className = 'zip-lookup-btn' + (state !== 'idle' && state !== 'loading' ? ' ' + state : '');

  if (state === 'loading') {
    btn.innerHTML = '<span class="spinner"></span> Searching';
  } else if (state === 'success') {
    btn.innerHTML = 'âœ“ Found';
    setTimeout(() => { if (btn) { btn.innerHTML = 'Look up â†’'; btn.className = 'zip-lookup-btn'; btn.disabled = false; } }, 3000);
  } else if (state === 'error') {
    btn.innerHTML = 'âœ— Try again';
    setTimeout(() => { if (btn) { btn.innerHTML = 'Look up â†’'; btn.className = 'zip-lookup-btn'; btn.disabled = false; } }, 4000);
  } else {
    btn.innerHTML = 'Look up â†’';
  }

  if (inp) {
    inp.className = 'zip-input' + (state === 'success' ? ' success' : state === 'error' ? ' error' : '');
    if (state !== 'loading' && state !== 'idle') {
      setTimeout(() => { if (inp) inp.className = 'zip-input'; }, 4000);
    }
  }

  if (fb) {
    fb.textContent = feedback || '';
    fb.className   = 'zip-feedback' + (state === 'success' ? ' success' : state === 'error' ? ' error' : '');
  }
}

function setLocationText(txt) { document.getElementById('ts-location').textContent = txt; }
function getLocationForSave() { return locationData || {}; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ENV CARD â€” SUMMARY BAR & COLLAPSE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let envDetailOpen = false;

function toggleEnvDetail() {
  envDetailOpen = !envDetailOpen;
  document.getElementById('env-detail').classList.toggle('open', envDetailOpen);
  document.getElementById('esb-chevron').classList.toggle('open', envDetailOpen);
}

function openEnvDetail() {
  envDetailOpen = true;
  document.getElementById('env-detail').classList.add('open');
  const chev = document.getElementById('esb-chevron');
  if (chev) chev.classList.add('open');
}

function hideEnvSummary() {
  document.getElementById('env-summary-bar').style.display = 'none';
}

function showEnvSummary(main, sub) {
  const bar = document.getElementById('env-summary-bar');
  bar.style.display = 'flex';
  document.getElementById('esb-main').textContent = main;
  document.getElementById('esb-sub').textContent  = sub;
  if (isMobile()) {
    envDetailOpen = false;
    document.getElementById('env-detail').classList.remove('open');
    document.getElementById('esb-chevron').classList.remove('open');
  } else {
    openEnvDetail();
  }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   WEATHER & AIR QUALITY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showWxStatus(show) {
  document.getElementById('wx-status').style.display = show ? 'flex' : 'none';
}

function setWxStatus(msg, type='') {
  const el = document.getElementById('wx-status');
  el.className = 'wx-status ' + type;
  el.innerHTML = `<span>${type==='success'?'âœ…':type==='error'?'âš ï¸':'ğŸ“'}</span><span>${msg}</span>`;
}

function setWxVal(id, val) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = val ?? 'â€”';
  el.classList.toggle('empty', val == null || val === '');
}

async function fetchWeatherCoords(lat, lon, altitude) {
  showWxStatus(true);
  setWxStatus('Fetching weather & air qualityâ€¦');
  try {
    const [wxRes, aqRes] = await Promise.all([
      fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +
        `&current=temperature_2m,relative_humidity_2m,precipitation,surface_pressure,wind_speed_10m,cloud_cover` +
        `&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=auto`,
        { signal: AbortSignal.timeout(10000) }),
      fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}` +
        `&current=us_aqi,pm2_5,pm10,ozone,nitrogen_dioxide&timezone=auto`,
        { signal: AbortSignal.timeout(10000) })
    ]);

    if (!wxRes.ok) throw new Error('weather API error');
    const wxD = await wxRes.json();
    const c   = wxD.current;
    const mp  = moonPhase();

    weatherData = {
      lat, lon,
      altitude:    altitude != null ? Math.round(altitude) + ' m' : 'N/A',
      altitudeRaw: altitude != null ? Math.round(altitude) : null,
      temp:        c.temperature_2m.toFixed(1) + 'Â°F',     tempRaw:     c.temperature_2m,
      humidity:    c.relative_humidity_2m + '%',           humidityRaw: c.relative_humidity_2m,
      precip:      c.precipitation + ' in',               precipRaw:   c.precipitation,
      pressure:    c.surface_pressure.toFixed(0) + ' hPa',pressureRaw: c.surface_pressure,
      wind:        c.wind_speed_10m.toFixed(1) + ' mph',  windRaw:     c.wind_speed_10m,
      cloud:       c.cloud_cover + '%',                   cloudRaw:    c.cloud_cover,
      moon:        mp.label, moonVal: mp.val,
      source:      'auto',
    };

    setWxVal('wd-temp',   weatherData.temp);
    setWxVal('wd-hum',    weatherData.humidity);
    setWxVal('wd-precip', weatherData.precip);
    setWxVal('wd-pres',   weatherData.pressure);
    setWxVal('wd-wind',   weatherData.wind);
    setWxVal('wd-cloud',  weatherData.cloud);
    setWxVal('wd-moon',   weatherData.moon);
    setWxVal('wd-alt',    weatherData.altitude);

    // Air quality â€” parallel, non-fatal if it fails
    aqData = {};
    if (aqRes.ok) {
      const aqD = await aqRes.json();
      const aq  = aqD.current;
      aqData = {
        aqi:    aq.us_aqi,
        pm25:   aq.pm2_5              != null ? +aq.pm2_5.toFixed(1)              : null,
        pm10:   aq.pm10               != null ? +aq.pm10.toFixed(1)               : null,
        ozone:  aq.ozone              != null ? +aq.ozone.toFixed(1)              : null,
        no2:    aq.nitrogen_dioxide   != null ? +aq.nitrogen_dioxide.toFixed(1)   : null,
        source: 'auto',
      };
      renderAQI(aqData);
      document.getElementById('aq-status-label').textContent = 'â€” CAMS / Copernicus';
    } else {
      document.getElementById('aq-status-label').textContent = 'â€” unavailable';
    }

    // Success â€” hide status bar, show summary bar
    showWxStatus(false);
    const cat     = aqiCategory(aqData.aqi);
    const locName = locationData?.display || coordStr(lat, lon);
    showEnvSummary(
      `${locName}  Â·  ${weatherData.temp}  Â·  ${weatherData.wind}`,
      `AQI ${aqData.aqi ?? 'â€”'} ${cat.label}  Â·  ${weatherData.moon}  Â·  Humidity ${weatherData.humidity}`
    );

  } catch (err) {
    showWxStatus(true);
    const isNetwork = err?.name === 'TypeError' || err?.name === 'AbortError';
    setWxStatus(
      isNetwork
        ? 'Network unavailable â€” enter ZIP or use manual override âœï¸'
        : 'Weather API error â€” use manual override âœï¸',
      'error'
    );
    openEnvDetail();
    showZipPanel();  // surface zip entry so user has a clear path
  }
}

function refreshWeather() {
  weatherData = {}; aqData = {};
  ['wd-temp','wd-hum','wd-precip','wd-pres','wd-wind','wd-cloud','wd-moon','wd-alt',
   'wd-pm25','wd-pm10','wd-o3','wd-no2'].forEach(id => setWxVal(id, null));
  const aqiEl = document.getElementById('wd-aqi');
  if (aqiEl) { aqiEl.textContent = 'â€”'; aqiEl.classList.add('empty'); }
  document.getElementById('aq-status-label').textContent = 'fetchingâ€¦';
  hideEnvSummary();
  initEnvChain();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LEGACY stubs â€” kept so nothing breaks if referenced
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function fetchLocation() { initEnvChain(); }
function fetchWeather()  { initEnvChain(); }

function toggleManual() {
  manualOpen = !manualOpen;
  document.getElementById('manual-panel').classList.toggle('open', manualOpen);
  document.getElementById('manual-toggle-btn').textContent =
    manualOpen ? 'âœï¸ Hide manual overrides' : 'âœï¸ Override values manually';
  if (manualOpen) openEnvDetail();
}

/* AQI helpers */
function aqiCategory(v) {
  if (v == null) return { label:'â€”', cls:'' };
  if (v <= 50)  return { label:'Good',                    cls:'aqi-good'      };
  if (v <= 100) return { label:'Moderate',                cls:'aqi-moderate'  };
  if (v <= 150) return { label:'Unhealthy for Sensitive', cls:'aqi-sensitive' };
  if (v <= 200) return { label:'Unhealthy',               cls:'aqi-unhealthy' };
  if (v <= 300) return { label:'Very Unhealthy',          cls:'aqi-very'      };
  return               { label:'Hazardous',               cls:'aqi-hazardous' };
}

function renderAQI(aq) {
  const cat   = aqiCategory(aq.aqi);
  const aqiEl = document.getElementById('wd-aqi');
  if (aqiEl) {
    aqiEl.innerHTML = aq.aqi != null
      ? `<strong style="font-size:1.05rem">${aq.aqi}</strong><span class="aqi-badge ${cat.cls}">${cat.label}</span>`
      : 'â€”';
    aqiEl.classList.toggle('empty', aq.aqi == null);
  }
  setWxVal('wd-pm25', aq.pm25  != null ? aq.pm25  : null);
  setWxVal('wd-pm10', aq.pm10  != null ? aq.pm10  : null);
  setWxVal('wd-o3',   aq.ozone != null ? aq.ozone : null);
  setWxVal('wd-no2',  aq.no2   != null ? aq.no2   : null);
}

/* Manual field indicator â€” amber "MANUAL" tag on input */
function markManual(inputId, wrapId) {
  const wrap  = document.getElementById(wrapId);
  const input = document.getElementById(inputId);
  if (!wrap || !input) return;
  wrap.classList.toggle('overridden', input.value.trim() !== '');
}

/* Apply manual values button */
function applyManualValues() {
  const btn = document.getElementById('apply-manual-btn');
  // Just give visual confirmation â€” values are read at save time
  btn.textContent = 'âœ“ Applied!';
  btn.classList.add('success');
  toast('âœï¸ Manual values will be used for this entry', 'success');
  setTimeout(() => {
    btn.textContent = 'âœ“ Apply manual values';
    btn.classList.remove('success');
  }, 2500);
}

function moonPhase() {
  const known = new Date('2024-01-11');
  const val   = ((Date.now() - known) / 86400000 % 29.53059) / 29.53059;
  const labels = ['ğŸŒ‘ New','ğŸŒ’ Wax Crescent','ğŸŒ“ First Qtr','ğŸŒ” Wax Gibbous','ğŸŒ• Full','ğŸŒ– Wan Gibbous','ğŸŒ— Last Qtr','ğŸŒ˜ Wan Crescent'];
  return { val, label: labels[Math.floor(val * 8)] };
}

function getManual() {
  const g = id => { const v = parseFloat(document.getElementById(id)?.value); return isNaN(v)?null:v; };
  return {
    tempRaw:g('wm-temp'), humidityRaw:g('wm-hum'), precipRaw:g('wm-precip'),
    pressureRaw:g('wm-pres'), windRaw:g('wm-wind'), cloudRaw:g('wm-cloud'),
    altitudeRaw:g('wm-alt'), aqi:g('wm-aqi'),
    pm25:g('wm-pm25'), pm10:g('wm-pm10'), ozone:g('wm-o3'), no2:g('wm-no2'),
  };
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SLIDERS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pickSlider(id, val) {
  val = parseInt(val);
  const badge = document.getElementById('sb-' + id);
  if (val === 0) {
    if (badge) { badge.textContent='â€”'; badge.style.color=''; badge.style.borderColor=''; badge.style.background=''; }
    updateSliderColor(id, 0);
    return;
  }
  if (badge) {
    const c = scaleColor(val);
    badge.textContent = val;
    badge.style.color = c;
    badge.style.borderColor = c+'66';
    badge.style.background  = c+'18';
  }
  updateSliderColor(id, val);
}

function updateSliderColor(id, val) {
  const slider = document.getElementById('sl-' + id);
  if (!slider) return;
  const c = val === 0 ? '#272b3c' : scaleColor(val);
  const pct = val / 10 * 100;
  slider.style.background = val === 0
    ? 'var(--s2)'
    : `linear-gradient(to right, ${c} 0%, ${c} ${pct}%, var(--s2) ${pct}%, var(--s2) 100%)`;
  // thumb glow color
  slider.style.setProperty('--thumb-color', c);
}

function scaleColor(v) {
  if (v <= 2) return '#7ec99a';
  if (v <= 4) return '#6ab0f5';
  if (v <= 6) return '#f2a94e';
  if (v <= 8) return '#e8778a';
  return '#f05050';
}

function getSliderVal(id) {
  const el = document.getElementById('sl-' + id);
  if (!el) return null;
  const v = parseInt(el.value);
  return v === 0 ? null : v;
}

function resetSliders() {
  SLIDER_IDS.forEach(id => {
    const el = document.getElementById('sl-' + id);
    if (el) { el.value = 0; pickSlider(id, 0); }
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CHECKBOXES
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleTile(el) { el.classList.toggle('on'); }
function getChecked(id) {
  return [...document.getElementById(id).querySelectorAll('.check-tile.on')].map(el=>el.textContent.trim());
}
function resetChecked(id) { document.getElementById(id).querySelectorAll('.check-tile.on').forEach(el=>el.classList.remove('on')); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MOOD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function pickMood(el, mood) {
  document.querySelectorAll('.mood-tile').forEach(m=>m.classList.remove('on'));
  el.classList.add('on'); selectedMood = mood;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MOBILE WIZARD
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function initWizard() {
  if (isMobile()) {
    document.getElementById('wizard-nav').classList.add('visible');
    showStep(1);
  }
}

function showStep(n) {
  currentStep = Math.max(1, Math.min(TOTAL_STEPS, n));
  document.querySelectorAll('.wizard-step').forEach(s => {
    s.classList.toggle('active', parseInt(s.dataset.step) === currentStep);
  });
  const pct = (currentStep / TOTAL_STEPS * 100).toFixed(0);
  document.getElementById('wizard-bar').style.width = pct + '%';
  document.getElementById('wizard-step-label').textContent = `Step ${currentStep} of ${TOTAL_STEPS}`;
  const stepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
  document.getElementById('wizard-step-name').textContent = stepEl?.dataset.name || '';

  const backBtn = document.getElementById('wiz-back');
  const nextBtn = document.getElementById('wiz-next');
  backBtn.disabled = currentStep === 1;
  backBtn.style.opacity = currentStep === 1 ? '0.4' : '1';

  if (currentStep === TOTAL_STEPS) {
    nextBtn.textContent = 'ğŸ’¾ Save & Download';
    nextBtn.onclick = saveEntry;
  } else {
    nextBtn.textContent = 'Next â†’';
    nextBtn.onclick = wizardNext;
  }
  window.scrollTo({ top:0, behavior:'smooth' });
}

function wizardNext() { showStep(currentStep + 1); }
function wizardBack() { showStep(currentStep - 1); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SAVE & DOWNLOAD (combined)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function saveEntry() {
  const now = new Date();
  const manual = getManual();
  const loc    = getLocationForSave();

  const w = {
    ...weatherData,
    tempRaw:     manual.tempRaw     ?? weatherData.tempRaw,
    humidityRaw: manual.humidityRaw ?? weatherData.humidityRaw,
    precipRaw:   manual.precipRaw   ?? weatherData.precipRaw,
    pressureRaw: manual.pressureRaw ?? weatherData.pressureRaw,
    windRaw:     manual.windRaw     ?? weatherData.windRaw,
    cloudRaw:    manual.cloudRaw    ?? weatherData.cloudRaw,
    altitudeRaw: manual.altitudeRaw ?? weatherData.altitudeRaw ?? null,
    // Air quality â€” manual overrides auto
    aqi:    manual.aqi   ?? aqData.aqi   ?? null,
    pm25:   manual.pm25  ?? aqData.pm25  ?? null,
    pm10:   manual.pm10  ?? aqData.pm10  ?? null,
    ozone:  manual.ozone ?? aqData.ozone ?? null,
    no2:    manual.no2   ?? aqData.no2   ?? null,
    aqCategory: aqiCategory(manual.aqi ?? aqData.aqi).label,
  };

  // Derive time-of-day session label from timestamp
  const h = now.getHours();
  const sessionLabel = h >= 6 && h < 12 ? 'morning' : h >= 12 && h < 18 ? 'afternoon' : 'evening';

  const entry = {
    id:            now.getTime(),
    timestamp:     now.toISOString(),
    date:          now.toISOString().split('T')[0],
    timeOfDay:     sessionLabel,
    // location
    location:      loc,
    // pain
    painLocations: getChecked('cg-locations'),
    painTypes:     getChecked('cg-paintypes'),
    painOverall:   getSliderVal('pain-overall'),
    fatigue:       getSliderVal('fatigue'),
    stiffness:     getSliderVal('stiffness'),
    sleep:         getSliderVal('sleep'),
    brainfog:      getSliderVal('brainfog'),
    sensitivity:   getSliderVal('sensitivity'),
    flare:         getSliderVal('flare'),
    // mental
    mood:          selectedMood,
    depression:    getSliderVal('depression'),
    anxiety:       getSliderVal('anxiety'),
    stress:        getSliderVal('stress'),
    overwhelm:     getSliderVal('overwhelm'),
    isolation:     getSliderVal('isolation'),
    // other
    otherSymptoms: getChecked('cg-other'),
    activity:      getSliderVal('activity'),
    medication:    getSliderVal('medication'),
    notes:         document.getElementById('daily-notes').value.trim(),
    weather:       w,
  };

  appData.entries.push(entry);
  appData.entries.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
  sessionStorage.setItem('fibro-v4', JSON.stringify(appData));
  updateSummary();
  updateYesterdayBtn();

  // Try File System Access API first
  const json = JSON.stringify(appData, null, 2);
  let saved = false;

  if ('showSaveFilePicker' in window) {
    try {
      if (!fileHandle) {
        fileHandle = await window.showSaveFilePicker({
          suggestedName: 'fibroflow-data.json',
          types: [{ description:'FibroFlow Data', accept:{'application/json':['.json']} }]
        });
      }
      const writable = await fileHandle.createWritable();
      await writable.write(json);
      await writable.close();
      saved = true;
      toast('âœ… Saved & written to file!', 'success');
    } catch(e) {
      if (e.name !== 'AbortError') {
        fileHandle = null; // reset so next save tries again
        fallbackDownload(json);
        saved = true;
      }
    }
  }

  if (!saved) {
    fallbackDownload(json);
    toast('âœ… Saved! File downloaded.', 'success');
  }

  // On mobile: go back to step 1 after save
  if (isMobile()) { resetForm(); showStep(1); }
}

function fallbackDownload(json) {
  const blob = new Blob([json], {type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = `fibroflow-${new Date().toISOString().split('T')[0]}.json`;
  a.click(); URL.revokeObjectURL(url);
  toast('âœ… Saved! File downloaded.','success');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SHORTCUTS: None today / Same as yesterday
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function noneToday(gridId) {
  resetChecked(gridId);
  toast('âœ• Cleared â€” marked as none today');
}

function updateYesterdayBtn() {
  const row = document.getElementById('yesterday-row');
  if (!row) return;
  row.style.display = appData.entries.length ? 'flex' : 'none';
}

function sameAsYesterday() {
  if (!appData.entries.length) return;
  // Get most recent entry
  const prev = appData.entries[appData.entries.length - 1];

  // Pre-fill sliders
  const sliderMap = {
    'pain-overall': prev.painOverall, 'fatigue': prev.fatigue,
    'stiffness': prev.stiffness, 'sleep': prev.sleep,
    'brainfog': prev.brainfog, 'sensitivity': prev.sensitivity,
    'flare': prev.flare, 'depression': prev.depression,
    'anxiety': prev.anxiety, 'stress': prev.stress,
    'overwhelm': prev.overwhelm, 'isolation': prev.isolation,
    'activity': prev.activity, 'medication': prev.medication,
  };
  Object.entries(sliderMap).forEach(([id, val]) => {
    if (val == null) return;
    const el = document.getElementById('sl-' + id);
    if (el) { el.value = val; pickSlider(id, val); }
  });

  // Pre-fill checkboxes
  const fillGrid = (gridId, values) => {
    if (!values?.length) return;
    document.getElementById(gridId)?.querySelectorAll('.check-tile').forEach(tile => {
      const label = tile.textContent.trim();
      tile.classList.toggle('on', values.includes(label));
    });
  };
  fillGrid('cg-locations', prev.painLocations);
  fillGrid('cg-paintypes', prev.painTypes);
  fillGrid('cg-other', prev.otherSymptoms);

  // Pre-fill mood
  if (prev.mood) {
    document.querySelectorAll('.mood-tile').forEach(t => t.classList.remove('on'));
    document.querySelectorAll('.mood-tile').forEach(t => {
      if (t.getAttribute('onclick')?.includes(`'${prev.mood}'`)) t.classList.add('on');
    });
    selectedMood = prev.mood;
  }

  // Pre-fill notes
  const notesEl = document.getElementById('daily-notes');
  if (notesEl && prev.notes) notesEl.value = prev.notes;

  toast('ğŸ“‹ Pre-filled from your last entry â€” adjust what\'s different', 'success');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   RESET
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function resetForm() {
  resetSliders();
  resetChecked('cg-locations'); resetChecked('cg-paintypes'); resetChecked('cg-other');
  document.querySelectorAll('.mood-tile.on').forEach(m=>m.classList.remove('on'));
  selectedMood = '';
  document.getElementById('daily-notes').value = '';
  const manualIds = ['wm-temp','wm-hum','wm-precip','wm-pres','wm-wind','wm-cloud','wm-alt','wm-aqi','wm-pm25','wm-pm10','wm-o3','wm-no2'];
  manualIds.forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
    const wrap=document.getElementById('wrap-'+id); if(wrap) wrap.classList.remove('overridden');
  });
}

function restoreSession() {
  const s = sessionStorage.getItem('fibro-v4');
  if (!s) return;
  try { appData = JSON.parse(s); updateSummary(); toast('ğŸ“‚ Previous session restored'); } catch{}
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   EXPORT / IMPORT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function exportJSON() {
  if (!appData.entries.length) { toast('No data to export','error'); return; }
  const blob = new Blob([JSON.stringify(appData,null,2)],{type:'application/json'});
  dl(blob, `fibroflow-${today()}.json`);
  toast('ğŸ“¥ JSON exported!','success');
}

function exportCSV() {
  if (!appData.entries.length) { toast('No data to export','error'); return; }
  const cols = ['timestamp','date','timeOfDay','location','zip',
    'painOverall','fatigue','stiffness','sleep','brainfog','sensitivity','flare',
    'depression','anxiety','stress','overwhelm','isolation','mood','activity','medication',
    'temp_F','humidity_pct','precip_in','pressure_hPa','wind_mph','cloud_pct','altitude_m',
    'aqi','aqi_category','pm25','pm10','ozone','no2','moon',
    'painLocations','painTypes','otherSymptoms','notes'];
  const rows = appData.entries.map(e => {
    const w = e.weather||{};
    return [
      e.timestamp, e.date, e.timeOfDay||'', e.location?.display||'', e.location?.zip||'',
      e.painOverall??'', e.fatigue??'', e.stiffness??'', e.sleep??'',
      e.brainfog??'', e.sensitivity??'', e.flare??'',
      e.depression??'', e.anxiety??'', e.stress??'', e.overwhelm??'', e.isolation??'', e.mood||'',
      e.activity??'', e.medication??'',
      w.tempRaw??'', w.humidityRaw??'', w.precipRaw??'', w.pressureRaw??'',
      w.windRaw??'', w.cloudRaw??'', w.altitudeRaw??'',
      w.aqi??'', w.aqCategory||'', w.pm25??'', w.pm10??'', w.ozone??'', w.no2??'', w.moon||'',
      `"${(e.painLocations||[]).join('; ')}"`,
      `"${(e.painTypes||[]).join('; ')}"`,
      `"${(e.otherSymptoms||[]).join('; ')}"`,
      `"${(e.notes||'').replace(/"/g,'""')}"`,
    ].join(',');
  });
  dl(new Blob([[cols.join(','),...rows].join('\n')],{type:'text/csv'}), `fibroflow-${today()}.csv`);
  toast('ğŸ“Š CSV exported!','success');
}

function dl(blob, name) {
  const url=URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
}

function importFile(ev) {
  const file = ev.target.files[0]; if(!file) return; ev.target.value='';
  const r = new FileReader();
  r.onload = e => file.name.endsWith('.json') ? importJSON(e.target.result) : importCSV(e.target.result);
  r.readAsText(file);
}

function importJSON(text) {
  try {
    const imp = JSON.parse(text);
    if (!Array.isArray(imp.entries)) throw new Error();
    mergeEntries(imp.entries);
    toast(`âœ… Loaded ${imp.entries.length} entries`,'success');
  } catch { toast('âŒ Invalid JSON file','error'); }
}

function importCSV(text) {
  try {
    const lines = text.trim().split('\n'), headers = lines[0].split(',');
    const entries = [];
    for (let i=1; i<lines.length; i++) {
      const vals = parseCSVLine(lines[i]), obj={};
      headers.forEach((h,idx)=>obj[h.trim()]=vals[idx]??'');
      const n = v => { const x=parseFloat(v); return isNaN(x)?null:x; };
      if (!obj.timestamp && !obj.date) continue;
      entries.push({
        id: Date.now()+i,
        timestamp: obj.timestamp || (obj.date+'T12:00:00.000Z'),
        date: obj.date, timeOfDay: obj.timeOfDay||obj.session||'',
        location: { display: obj.location||'' },
        painOverall:n(obj.painOverall), fatigue:n(obj.fatigue), stiffness:n(obj.stiffness),
        sleep:n(obj.sleep), brainfog:n(obj.brainfog), sensitivity:n(obj.sensitivity), flare:n(obj.flare),
        depression:n(obj.depression), anxiety:n(obj.anxiety), stress:n(obj.stress),
        overwhelm:n(obj.overwhelm), isolation:n(obj.isolation), mood:obj.mood||'',
        activity:n(obj.activity), medication:n(obj.medication), notes:obj.notes||'',
        painLocations:(obj.painLocations||'').split('; ').filter(Boolean),
        painTypes:(obj.painTypes||'').split('; ').filter(Boolean),
        otherSymptoms:(obj.otherSymptoms||'').split('; ').filter(Boolean),
        weather:{
          tempRaw:n(obj.temp_F), humidityRaw:n(obj.humidity_pct), precipRaw:n(obj.precip_in),
          pressureRaw:n(obj.pressure_hPa), windRaw:n(obj.wind_mph), cloudRaw:n(obj.cloud_pct),
          altitudeRaw:n(obj.altitude_m), aqi:n(obj.aqi), moon:obj.moon||'',
        }
      });
    }
    mergeEntries(entries);
    toast(`âœ… Loaded ${entries.length} entries from CSV`,'success');
  } catch { toast('âŒ Could not parse CSV','error'); }
}

function parseCSVLine(line) {
  const res=[]; let inQ=false, cur='';
  for(const c of line) { if(c==='"'){inQ=!inQ;continue;} if(c===','&&!inQ){res.push(cur);cur='';continue;} cur+=c; }
  res.push(cur); return res;
}

function mergeEntries(incoming) {
  const ids = new Set(appData.entries.map(e=>e.id));
  incoming.filter(e=>!ids.has(e.id)).forEach(e=>appData.entries.push(e));
  appData.entries.sort((a,b)=>new Date(a.timestamp)-new Date(b.timestamp));
  sessionStorage.setItem('fibro-v4', JSON.stringify(appData));
  updateSummary();
  updateYesterdayBtn();
}

function clearAll() {
  if(!confirm('Clear all session data?')) return;
  appData={entries:[]}; sessionStorage.removeItem('fibro-v4');
  updateSummary(); toast('ğŸ—‘ï¸ Session data cleared');
}

function today() { return new Date().toISOString().split('T')[0]; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   SUMMARY
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function updateSummary() {
  const el=document.getElementById('data-summary'); if(!el) return;
  const n=appData.entries.length;
  if(!n){el.textContent='No entries logged yet.';return;}
  const dates=[...new Set(appData.entries.map(e=>e.date))];
  const painE=appData.entries.filter(e=>e.painOverall!=null);
  const avg=painE.length?(painE.reduce((s,e)=>s+e.painOverall,0)/painE.length).toFixed(1):'â€”';
  el.innerHTML=`<strong>${n}</strong> total entries across <strong>${dates.length}</strong> days<br>
    First: <strong>${dates[0]}</strong> Â· Latest: <strong>${dates[dates.length-1]}</strong><br>
    Avg overall pain: <strong>${avg}/10</strong><br>
    Breakdown: ${appData.entries.filter(e=>e.timeOfDay==='morning').length} morning Â· ${appData.entries.filter(e=>e.timeOfDay==='afternoon').length} afternoon Â· ${appData.entries.filter(e=>e.timeOfDay==='evening').length} evening`;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   NAVIGATION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function showPage(name, btn, botId) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab,.bot-tab').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (botId) document.getElementById(botId)?.classList.add('active');

  const wizNav = document.getElementById('wizard-nav');
  if (name==='log' && isMobile()) { wizNav.classList.add('visible'); showStep(currentStep); }
  else wizNav.classList.remove('visible');

  handleDesktopSave();
  if (name==='dashboard') renderDash();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DASHBOARD â€” FILTER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function onRangeChange() {
  const v = document.getElementById('range-sel').value;
  document.getElementById('date-range-row').classList.toggle('show', v==='custom');
  if (v!=='custom') renderDash();
}

function applyCustomRange() { renderDash(); }

function getFiltered() {
  let entries = [...appData.entries];
  const range = document.getElementById('range-sel').value;
  if (range === 'custom') {
    const from = document.getElementById('date-from').value;
    const to   = document.getElementById('date-to').value;
    if (from) entries = entries.filter(e => e.date >= from);
    if (to)   entries = entries.filter(e => e.date <= to);
  } else if (parseInt(range) > 0) {
    const cut = new Date(); cut.setDate(cut.getDate()-parseInt(range));
    entries = entries.filter(e => new Date(e.date) >= cut);
  }
  const sess = document.getElementById('session-sel').value;
  if (sess !== 'all') entries = entries.filter(e => e.timeOfDay === sess || e.session === sess);
  return entries;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DASHBOARD â€” RENDER
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function renderDash() {
  const nd = document.getElementById('dash-no-data');
  const dc = document.getElementById('dash-content');
  if (!appData.entries.length) { nd.style.display='block'; dc.style.display='none'; return; }
  nd.style.display='none'; dc.style.display='block';
  buildChips(); buildStats(); buildCharts();
}

function buildChips() {
  ['physical','mental','env'].forEach(group=>{
    const c=document.getElementById('chips-'+group); c.innerHTML='';
    FILTER_CFG.filter(f=>f.group===group).forEach(f=>{
      const chip=document.createElement('div');
      chip.className='chip'+(filters[f.key]?' on':'');
      chip.dataset.key=f.key;
      chip.innerHTML=`<span class="cdot" style="background:${f.color}"></span>${f.label}`;
      chip.onclick=()=>{ filters[f.key]=!filters[f.key]; chip.classList.toggle('on',filters[f.key]); updateFilterCount(group); buildCharts(); };
      c.appendChild(chip);
    });
    updateFilterCount(group);
  });
}

function updateFilterCount(group) {
  const count = FILTER_CFG.filter(f=>f.group===group&&filters[f.key]).length;
  const el = document.getElementById('ftc-'+group);
  if (el) el.textContent = count;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   BOTTOM SHEET (mobile chart filters)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let activeSheetGroup = null;

function openSheet(group) {
  activeSheetGroup = group;
  const titles = { physical:'Physical Symptoms', mental:'Mental & Emotional', env:'Environmental' };
  document.getElementById('sheet-title').textContent = 'âš™ ' + (titles[group] || group);

  const grid = document.getElementById('sheet-toggle-grid');
  grid.innerHTML = '';
  FILTER_CFG.filter(f=>f.group===group).forEach(f=>{
    const tog = document.createElement('div');
    tog.className = 'sheet-toggle' + (filters[f.key] ? ' on' : '');
    tog.dataset.key = f.key;
    tog.innerHTML = `
      <div class="st-bar" style="background:${f.color}"></div>
      <span class="st-label">${f.label}</span>
      <div class="st-check">âœ“</div>
    `;
    tog.onclick = () => {
      filters[f.key] = !filters[f.key];
      tog.classList.toggle('on', filters[f.key]);
      // Sync desktop chip
      const chip = document.querySelector(`#chips-${group} .chip[data-key="${f.key}"]`);
      if (chip) chip.classList.toggle('on', filters[f.key]);
      updateFilterCount(group);
      buildCharts();
    };
    grid.appendChild(tog);
  });

  document.getElementById('sheet-backdrop').classList.add('open');
  document.getElementById('bottom-sheet').classList.add('open');
}

function closeSheet() {
  document.getElementById('sheet-backdrop').classList.remove('open');
  document.getElementById('bottom-sheet').classList.remove('open');
  activeSheetGroup = null;
}

function buildStats() {
  const entries=getFiltered(), grid=document.getElementById('dash-stats'); grid.innerHTML='';
  [
    {v:entries.length, l:'Entries'},
    {v:new Set(entries.map(e=>e.date)).size, l:'Days'},
    {v:avgStat(entries,'painOverall'), l:'Avg Pain'},
    {v:avgStat(entries,'fatigue'),     l:'Avg Fatigue'},
    {v:avgStat(entries,'anxiety'),     l:'Avg Anxiety'},
    {v:bestDay(entries),               l:'Best Day'},
  ].forEach(s=>grid.insertAdjacentHTML('beforeend',`<div class="stat-box"><div class="stat-val">${s.v}</div><div class="stat-lbl">${s.l}</div></div>`));
}

function avgStat(e,k){const v=e.map(x=>x[k]).filter(v=>v!=null);return v.length?(v.reduce((a,b)=>a+b)/v.length).toFixed(1):'â€”';}
function bestDay(entries){const m={};entries.forEach(e=>{if(e.painOverall)(m[e.date]=m[e.date]||[]).push(e.painOverall);});const a=Object.entries(m).map(([d,v])=>({d,a:v.reduce((x,y)=>x+y)/v.length}));return a.length?a.reduce((x,y)=>y.a<x.a?y:x).d.slice(5):'â€”';}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CHART FILL TOGGLE (per-chart)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function toggleFill(chartKey) {
  fillState[chartKey] = !fillState[chartKey];
  const btn = document.getElementById('fill-' + chartKey);
  if (btn) {
    btn.textContent = fillState[chartKey] ? 'Fill on' : 'Fill off';
    btn.classList.toggle('on', fillState[chartKey]);
  }
  buildCharts();
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CHART BUILDING
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function makeGrad(ctx, color, a1=0.3, a2=0) {
  const g = ctx.createLinearGradient(0,0,0,ctx.canvas.height);
  const h2 = v => Math.round(v*255).toString(16).padStart(2,'0');
  g.addColorStop(0, color+h2(a1)); g.addColorStop(1, color+h2(a2));
  return g;
}

function makeDS(canvas, f, data, useFill) {
  const ctx = canvas.getContext('2d');
  return {
    label: f.label, data,
    borderColor: f.color,
    backgroundColor: useFill ? makeGrad(ctx, f.color, 0.28, 0) : 'transparent',
    fill: useFill,
    tension: 0.42, borderWidth: 2.5, spanGaps: true,
    pointRadius: 5, pointHoverRadius: 8,
    pointBackgroundColor: f.color, pointBorderColor:'#0c0e14', pointBorderWidth:2,
    pointHoverBackgroundColor:'#fff', pointHoverBorderColor:f.color, pointHoverBorderWidth:2.5,
  };
}

function bandPlugin(yMax) {
  return { id:'bands', beforeDraw(chart) {
    if (yMax!==10) return;
    const {ctx,chartArea:{top,bottom,left,right},scales} = chart;
    if (!scales.y) return;
    ctx.save();
    [{from:0,to:2,c:'rgba(126,201,154,0.04)'},{from:2,to:4,c:'rgba(106,176,245,0.04)'},
     {from:4,to:6,c:'rgba(242,169,78,0.04)'},{from:6,to:8,c:'rgba(232,119,138,0.05)'},
     {from:8,to:10,c:'rgba(240,80,80,0.07)'}].forEach(b=>{
      const y1=scales.y.getPixelForValue(b.to), y2=scales.y.getPixelForValue(b.from);
      ctx.fillStyle=b.c; ctx.fillRect(left,y1,right-left,y2-y1);
    });
    ctx.restore();
  }};
}

function crosshairPlugin() {
  return { id:'xhair', afterDraw(chart) {
    if (!chart._hx) return;
    const {ctx,chartArea:{top,bottom}}=chart;
    ctx.save(); ctx.strokeStyle='rgba(255,255,255,0.13)'; ctx.lineWidth=1; ctx.setLineDash([4,4]);
    ctx.beginPath(); ctx.moveTo(chart._hx,top); ctx.lineTo(chart._hx,bottom); ctx.stroke(); ctx.restore();
  }};
}

function buildCharts() {
  const entries = getFiltered();
  const dates   = [...new Set(entries.map(e=>e.date))].sort();
  const labels  = dates.map(d=>{const[,m,dy]=d.split('-');return`${m}/${dy}`;});

  const dayAvg = key => dates.map(d=>{
    const vs=entries.filter(e=>e.date===d&&e[key]!=null).map(e=>e[key]);
    return vs.length?+(vs.reduce((a,b)=>a+b)/vs.length).toFixed(2):null;
  });
  const dayWx = raw => dates.map(d=>{
    const es=entries.filter(e=>e.date===d&&e.weather?.[raw]!=null);
    return es.length?es[0].weather[raw]:null;
  });

  const physC  = document.getElementById('chart-physical');
  const mentC  = document.getElementById('chart-mental');
  const envC   = document.getElementById('chart-env');

  const physDS = FILTER_CFG.filter(f=>f.group==='physical'&&filters[f.key])
    .map(f=>makeDS(physC,f,dayAvg(f.key),fillState.physical));
  const mentDS = FILTER_CFG.filter(f=>f.group==='mental'&&filters[f.key])
    .map(f=>makeDS(mentC,f,dayAvg(f.key),fillState.mental));
  const envDS  = [];
  FILTER_CFG.filter(f=>f.group==='env'&&filters[f.key]).forEach(f=>{
    let data = dayWx(f.raw);
    if (f.key==='pressure') data=data.map(v=>v!=null?+((v-980)/(1040-980)*100).toFixed(1):null);
    envDS.push(makeDS(envC,{...f,label:f.label+(f.key==='pressure'?' (%)':'')},data,fillState.env));
  });

  drawChart('chart-physical', labels, physDS, {yMin:0,yMax:10,bands:true});
  drawChart('chart-mental',   labels, mentDS, {yMin:0,yMax:10,bands:true});
  drawChart('chart-env',      labels, envDS,  {yMin:0,yMax:null,bands:false});
  buildOverlay(labels, physDS, mentDS, envDS);

  buildLegend('legend-physical', FILTER_CFG.filter(f=>f.group==='physical'), 'physical');
  buildLegend('legend-mental',   FILTER_CFG.filter(f=>f.group==='mental'),   'mental');
  buildLegend('legend-env',      FILTER_CFG.filter(f=>f.group==='env'),      'env');
}

function drawChart(id, labels, datasets, {yMin=0,yMax=10,bands=false}={}) {
  if (charts[id]){charts[id].destroy();delete charts[id];}
  const has = datasets.some(d=>d.data&&d.data.some(v=>v!=null));
  charts[id] = new Chart(document.getElementById(id),{
    type:'line',
    data:{labels,datasets:has?datasets:[{label:'No metrics selected',data:[],borderColor:'#3c3b52',borderDash:[6,4],borderWidth:1}]},
    options:{
      responsive:true, animation:{duration:600,easing:'easeInOutQuart'},
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:'#1f2230',borderColor:'rgba(255,255,255,0.1)',borderWidth:1,
          titleColor:'#eceaf6',titleFont:{family:'Outfit',size:12,weight:'600'},
          bodyFont:{family:'Outfit',size:11},bodySpacing:4,padding:12,cornerRadius:10,
          callbacks:{
            label(c){const v=c.parsed.y;if(v==null)return null;return`  ${c.dataset.label}: ${yMax===10?v.toFixed(1)+'/10':v.toFixed(1)}`;},
            labelColor(c){return{borderColor:c.dataset.borderColor,backgroundColor:c.dataset.borderColor,borderRadius:3};}
          }
        }
      },
      onHover(e,els,chart){chart._hx=els.length?els[0].element.x:null;chart.draw();},
      scales:{
        x:{ticks:{color:'#5a5870',font:{family:'Outfit',size:11},maxRotation:45,autoSkip:true,maxTicksLimit:12},grid:{color:'rgba(255,255,255,0.04)',drawTicks:false},border:{color:'rgba(255,255,255,0.06)'}},
        y:{min:yMin,max:yMax??undefined,
          ticks:{color:'#5a5870',font:{family:'JetBrains Mono',size:10},padding:8,stepSize:yMax===10?2:undefined,
            callback(v){if(yMax===10){const m={0:'0',2:'Mild',4:'Low',6:'Mod',8:'High',10:'Max'};return m[v]??'';}return v;}},
          grid:{color(c){return c.tick.value%2===0?'rgba(255,255,255,0.06)':'rgba(255,255,255,0.02)';},drawTicks:false},
          border:{color:'rgba(255,255,255,0.06)',dash:[3,3]}
        }
      }
    },
    plugins:[bandPlugin(yMax),crosshairPlugin()]
  });
}

function buildOverlay(labels, physDS, mentDS, envDS) {
  if (charts['chart-overlay']){charts['chart-overlay'].destroy();delete charts['chart-overlay'];}
  const useFill = fillState.overlay;
  const canvas = document.getElementById('chart-overlay');

  const symDS = [...physDS,...mentDS].map(d=>({
    ...d, borderWidth:2, pointRadius:3.5, pointHoverRadius:6,
    fill:useFill?d.fill:false, backgroundColor:useFill?d.backgroundColor:'transparent', yAxisID:'y',
  }));
  const eDS = envDS.map(d=>({
    ...d, borderWidth:2, borderDash:[5,3], pointRadius:3, pointHoverRadius:6,
    pointStyle:'rectRot', fill:false, backgroundColor:'transparent', yAxisID:'y1',
  }));
  const all = [...symDS,...eDS];
  const has = all.some(d=>d.data&&d.data.some(v=>v!=null));

  // build legend
  const lc=document.getElementById('legend-overlay'); lc.innerHTML='';
  all.forEach(d=>{
    const isEnv=d.yAxisID==='y1';
    const li=document.createElement('div'); li.className='legend-item';
    li.innerHTML=`<span class="legend-swatch" style="background:${d.borderColor};box-shadow:0 0 5px ${d.borderColor}88${isEnv?';border-top:2px dashed '+d.borderColor+';background:transparent;box-shadow:none':''}"></span>${d.label}${isEnv?' <span style="font-size:0.62rem;color:var(--dim)">env</span>':''}`;
    lc.appendChild(li);
  });

  charts['chart-overlay']=new Chart(canvas,{
    type:'line',
    data:{labels,datasets:has?all:[{label:'No metrics selected',data:[],borderColor:'#3c3b52',borderDash:[6,4],borderWidth:1}]},
    options:{
      responsive:true,animation:{duration:700,easing:'easeInOutQuart'},
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:'#1a1d28',borderColor:'rgba(255,255,255,0.12)',borderWidth:1,
          titleColor:'#eceaf6',titleFont:{family:'Outfit',size:12,weight:'600'},
          bodyFont:{family:'Outfit',size:11},bodySpacing:4,padding:14,cornerRadius:12,
          callbacks:{
            title(i){return`ğŸ“…  ${i[0].label}`;},
            label(c){const v=c.parsed.y;if(v==null)return null;const suf=c.dataset.yAxisID==='y1'?'':'/10';return`  ${c.dataset.label}: ${v.toFixed(1)}${suf}`;},
            labelColor(c){return{borderColor:c.dataset.borderColor,backgroundColor:c.dataset.borderColor,borderRadius:3};}
          }
        }
      },
      onHover(e,els,chart){chart._hx=els.length?els[0].element.x:null;chart.draw();},
      scales:{
        x:{ticks:{color:'#5a5870',font:{family:'Outfit',size:11},maxRotation:45,autoSkip:true,maxTicksLimit:14},grid:{color:'rgba(255,255,255,0.04)',drawTicks:false},border:{color:'rgba(255,255,255,0.07)'}},
        y:{type:'linear',position:'left',min:0,max:10,
          ticks:{color:'#5a5870',font:{family:'JetBrains Mono',size:10},padding:6,stepSize:2,callback(v){const m={0:'0',2:'Mild',4:'Low',6:'Mod',8:'High',10:'Max'};return m[v]??'';}},
          grid:{color(c){return c.tick.value%2===0?'rgba(255,255,255,0.05)':'rgba(255,255,255,0.015)';},drawTicks:false},
          border:{color:'rgba(255,255,255,0.07)',dash:[3,3]},
          title:{display:true,text:'Symptom Score',color:'#3c3b52',font:{family:'Outfit',size:10}}},
        y1:{type:'linear',position:'right',
          ticks:{color:'#5a5870',font:{family:'JetBrains Mono',size:10},padding:6,maxTicksLimit:6},
          grid:{drawOnChartArea:false,drawTicks:false},border:{color:'rgba(255,255,255,0.07)'},
          title:{display:true,text:'Environmental',color:'#3c3b52',font:{family:'Outfit',size:10}}}
      }
    },
    plugins:[bandPlugin(10),crosshairPlugin()]
  });
}

function buildLegend(cId, cfgItems, group) {
  const c=document.getElementById(cId); if(!c) return; c.innerHTML='';
  cfgItems.forEach(f=>{
    const on=filters[f.key];
    const li=document.createElement('div'); li.className='legend-item'+(on?'':' hidden');
    li.innerHTML=`<span class="legend-swatch" style="background:${f.color};box-shadow:0 0 6px ${f.color}88"></span>${f.label}`;
    li.title=`Click to ${on?'hide':'show'} ${f.label}`;
    li.onclick=()=>{
      filters[f.key]=!filters[f.key]; li.classList.toggle('hidden',!filters[f.key]);
      const chip=document.querySelector(`#chips-${group} .chip[data-key="${f.key}"]`);
      if(chip)chip.classList.toggle('on',filters[f.key]); buildCharts();
    };
    c.appendChild(li);
  });
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DEMO DATA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function loadDemoData() {
  if (appData.entries.length&&!confirm('Add 21 days of demo data?')) return;
  const moods=['calm','tired','anxious','hopeful','neutral','sad','overwhelmed','happy'];
  const timeSlots=['morning','afternoon','evening'];
  const now=new Date(); const entries=[];
  for(let d=20;d>=0;d--){
    const date=new Date(now); date.setDate(date.getDate()-d);
    const ds=date.toISOString().split('T')[0];
    const isFlare=d>=9&&d<=13;
    timeSlots.forEach((ts,si)=>{
      const jit=()=>(Math.random()-0.5)*2;
      const cl=(v,mn=1,mx=10)=>Math.max(mn,Math.min(mx,Math.round(v*10)/10));
      const off=[0,0.5,-0.3][si];
      const pain=cl((isFlare?7:3.5)+jit()+off);
      const h=[7,13,19][si];
      const entryDate=new Date(date); entryDate.setHours(h,Math.floor(Math.random()*60));
      entries.push({
        id:entryDate.getTime()+si,
        timestamp:entryDate.toISOString(), date:ds, timeOfDay:ts,
        location:{display:'Demo City, FL, USA',source:'demo'},
        painLocations:pain>6?['Neck & Shoulders','Lower Back','Widespread / All Over']:['Neck & Shoulders','Lower Back'],
        painTypes:['Aching / Dull','Burning'],
        painOverall:pain, fatigue:cl((isFlare?8:4.5)+jit()),
        stiffness:cl((isFlare?7:3)+jit()), sleep:cl((isFlare?7:4)+jit()),
        brainfog:cl((isFlare?6.5:3)+jit()), sensitivity:cl((isFlare?6.5:3)+jit()),
        flare:isFlare?cl(6+jit()):cl(1.5+jit()),
        mood:moods[Math.floor(Math.random()*moods.length)],
        depression:cl((isFlare?5.5:2.5)+jit()), anxiety:cl((isFlare?6:3.5)+jit()),
        stress:cl((isFlare?6:3)+jit()), overwhelm:cl((isFlare?5.5:2.5)+jit()),
        isolation:cl((isFlare?5:2)+jit()), otherSymptoms:isFlare?['Nausea','Headache']:['Headache'],
        activity:cl((isFlare?8:4)+jit()), medication:cl((isFlare?6:3)+jit()),
        notes:isFlare?'Flare-up day.':'Manageable day.',
        weather:{
          tempRaw:+(65+Math.sin(d*0.4)*8+jit()).toFixed(1),
          humidityRaw:Math.round(55+jit()*8), precipRaw:isFlare?+(Math.random()*0.4).toFixed(2):0,
          pressureRaw:+((isFlare?998:1013)+jit()*3).toFixed(0),
          windRaw:+(8+Math.random()*6).toFixed(1),
          cloudRaw:isFlare?Math.round(60+Math.random()*30):Math.round(20+Math.random()*30),
          moon:['ğŸŒ‘ New','ğŸŒ’ Wax Crescent','ğŸŒ“ First Qtr','ğŸŒ” Wax Gibbous','ğŸŒ• Full','ğŸŒ– Wan Gibbous','ğŸŒ— Last Qtr','ğŸŒ˜ Wan Crescent'][Math.floor(Math.random()*8)],
        }
      });
    });
  }
  mergeEntries(entries);
  filters.temp=true; filters.humidity=true; filters.pressure=true; filters.precip=true;
  renderDash();
  toast('âœ¨ Demo data loaded â€” 21 days','success');
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   DRAG & DROP
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const dz=document.getElementById('drop-zone');
dz.addEventListener('dragover',e=>{e.preventDefault();dz.classList.add('drag');});
dz.addEventListener('dragleave',()=>dz.classList.remove('drag'));
dz.addEventListener('drop',e=>{
  e.preventDefault(); dz.classList.remove('drag');
  const f=e.dataTransfer.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=ev=>f.name.endsWith('.json')?importJSON(ev.target.result):importCSV(ev.target.result); r.readAsText(f);
});

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TOAST
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let _tt;
function toast(msg,type=''){
  const el=document.getElementById('toast');
  el.textContent=msg; el.className='toast '+type+' show';
  clearTimeout(_tt); _tt=setTimeout(()=>el.classList.remove('show'),3800);
}
</script>
</body>
</html>
